{% extends "base.html" %}

{% block title %}编辑存储配置 - RClone备份系统{% endblock %}

{% block content %}
<div class="page-header-enhanced fade-in-up">
    <div class="container-fluid px-0">
        <div class="row align-items-center">
            <div class="col-lg-8 col-md-7">
                <div class="page-title-section">
                    <div class="page-title-icon">
                        <i class="bi bi-pencil-square"></i>
                    </div>
                    <div class="page-title-content">
                        <h1 class="page-title mb-1">编辑存储配置</h1>
                        <p class="page-subtitle mb-0">修改 "{{ config.name }}" 的配置信息</p>
                        <div class="page-stats mt-2">
                            <span class="stat-item">
                                {% if config.storage_type == 's3' %}
                                    <i class="bi bi-amazon me-1" style="color: #ff9900;"></i>Amazon S3
                                {% elif config.storage_type == 'alibaba_oss' %}
                                    <i class="bi bi-cloud me-1" style="color: #ff6a00;"></i>阿里云 OSS
                                {% elif config.storage_type == 'cloudflare_r2' %}
                                    <i class="bi bi-cloud me-1" style="color: #f38020;"></i>Cloudflare R2
                                {% elif config.storage_type == 'google_drive' %}
                                    <i class="bi bi-google me-1" style="color: #4285f4;"></i>Google Drive
                                {% elif config.storage_type == 'ftp' %}
                                    <i class="bi bi-hdd-network me-1" style="color: #6c757d;"></i>FTP
                                {% elif config.storage_type == 'sftp' %}
                                    <i class="bi bi-shield-lock me-1" style="color: #198754;"></i>SFTP
                                {% else %}
                                    <i class="bi bi-cloud me-1" style="color: #6c757d;"></i>{{ config.storage_type }}
                                {% endif %}
                            </span>
                            <span class="stat-item ms-3">
                                <i class="bi bi-calendar me-1"></i>
                                创建于 {{ config.created_at.strftime('%Y-%m-%d') }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-5">
                <div class="page-actions">
                    <a href="{{ url_for('storage_configs') }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left me-1"></i>
                        <span>返回列表</span>
                    </a>
                    <a href="{{ url_for('storage_config_history', config_id=config.id) }}" class="btn btn-outline-info">
                        <i class="bi bi-clock-history me-1"></i>
                        <span>历史版本</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑表单 -->
<div class="row fade-in-up" style="animation-delay: 0.2s;">
    <div class="col-12">
        <div class="glass-card">
            <form method="POST" action="{{ url_for('update_storage_config', config_id=config.id) }}">
                <!-- 基本信息 -->
                <div class="form-section mb-4">
                    <h5 class="form-section-title">
                        <i class="bi bi-info-circle me-2"></i>基本信息
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">配置名称 *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ config.name }}" required
                                       placeholder="例如：我的S3存储">
                                <div class="form-text">用于识别此存储配置的名称</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="storage_type" class="form-label">存储类型</label>
                                <input type="text" class="form-control" value="{{ config.storage_type }}" disabled>
                                <div class="form-text">存储类型创建后不可修改</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="可选，描述此配置的用途">{{ config.description or '' }}</textarea>
                    </div>
                </div>

                <!-- 配置参数 -->
                <div class="form-section mb-4">
                    <h5 class="form-section-title">
                        <i class="bi bi-gear me-2"></i>配置参数
                    </h5>
                    
                    {% if config.storage_type == 's3' %}
                    <!-- S3配置字段 -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Amazon S3配置</strong> - 支持AWS S3及兼容S3的存储服务
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="access_key" class="form-label">Access Key ID *</label>
                                <input type="text" class="form-control" id="access_key" name="access_key" 
                                       value="{{ rclone_config.get('access_key_id', '') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="secret_key" class="form-label">Secret Access Key *</label>
                                <input type="password" class="form-control" id="secret_key" name="secret_key" 
                                       value="{{ rclone_config.get('secret_access_key', '') }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="region" class="form-label">区域</label>
                                <select class="form-select" id="region" name="region">
                                    <option value="us-east-1" {{ 'selected' if rclone_config.get('region') == 'us-east-1' else '' }}>US East (N. Virginia)</option>
                                    <option value="us-west-1" {{ 'selected' if rclone_config.get('region') == 'us-west-1' else '' }}>US West (N. California)</option>
                                    <option value="us-west-2" {{ 'selected' if rclone_config.get('region') == 'us-west-2' else '' }}>US West (Oregon)</option>
                                    <option value="eu-west-1" {{ 'selected' if rclone_config.get('region') == 'eu-west-1' else '' }}>Europe (Ireland)</option>
                                    <option value="eu-central-1" {{ 'selected' if rclone_config.get('region') == 'eu-central-1' else '' }}>Europe (Frankfurt)</option>
                                    <option value="ap-southeast-1" {{ 'selected' if rclone_config.get('region') == 'ap-southeast-1' else '' }}>Asia Pacific (Singapore)</option>
                                    <option value="ap-northeast-1" {{ 'selected' if rclone_config.get('region') == 'ap-northeast-1' else '' }}>Asia Pacific (Tokyo)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endpoint" class="form-label">自定义端点</label>
                                <input type="text" class="form-control" id="endpoint" name="endpoint"
                                       value="{{ rclone_config.get('endpoint', '') }}"
                                       placeholder="可选，用于S3兼容存储">
                                <div class="form-text">留空使用AWS S3默认端点</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bucket" class="form-label">默认存储桶</label>
                        <input type="text" class="form-control" id="bucket" name="bucket"
                               value="{{ rclone_config.get('bucket', '') }}"
                               placeholder="可选，指定默认存储桶">
                    </div>
                    {% endif %}

                    {% if config.storage_type == 'alibaba_oss' %}
                    <!-- 阿里云OSS配置字段 -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>阿里云OSS配置</strong> - 使用S3兼容协议访问阿里云对象存储
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="oss_access_key" class="form-label">Access Key ID *</label>
                                <input type="text" class="form-control" id="oss_access_key" name="oss_access_key" 
                                       value="{{ rclone_config.get('access_key_id', '') }}" required>
                                <div class="form-text">阿里云AccessKey ID</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="oss_secret_key" class="form-label">Secret Access Key *</label>
                                <input type="password" class="form-control" id="oss_secret_key" name="oss_secret_key" 
                                       value="{{ rclone_config.get('secret_access_key', '') }}" required>
                                <div class="form-text">阿里云AccessKey Secret</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="oss_endpoint" class="form-label">Endpoint *</label>
                                <input type="text" class="form-control" id="oss_endpoint" name="oss_endpoint" 
                                       value="{{ rclone_config.get('endpoint', '') }}" required
                                       placeholder="例如：oss-cn-hangzhou.aliyuncs.com">
                                <div class="form-text">OSS区域端点地址，不包含https://</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="oss_region" class="form-label">区域</label>
                                <select class="form-select" id="oss_region" name="region">
                                    <option value="oss-cn-hangzhou" {{ 'selected' if rclone_config.get('region') == 'oss-cn-hangzhou' else '' }}>华东1（杭州）</option>
                                    <option value="oss-cn-shanghai" {{ 'selected' if rclone_config.get('region') == 'oss-cn-shanghai' else '' }}>华东2（上海）</option>
                                    <option value="oss-cn-beijing" {{ 'selected' if rclone_config.get('region') == 'oss-cn-beijing' else '' }}>华北2（北京）</option>
                                    <option value="oss-cn-shenzhen" {{ 'selected' if rclone_config.get('region') == 'oss-cn-shenzhen' else '' }}>华南1（深圳）</option>
                                    <option value="oss-cn-guangzhou" {{ 'selected' if rclone_config.get('region') == 'oss-cn-guangzhou' else '' }}>华南2（广州）</option>
                                    <option value="oss-cn-chengdu" {{ 'selected' if rclone_config.get('region') == 'oss-cn-chengdu' else '' }}>西南1（成都）</option>
                                    <option value="oss-cn-qingdao" {{ 'selected' if rclone_config.get('region') == 'oss-cn-qingdao' else '' }}>华北1（青岛）</option>
                                    <option value="oss-cn-zhangjiakou" {{ 'selected' if rclone_config.get('region') == 'oss-cn-zhangjiakou' else '' }}>华北3（张家口）</option>
                                    <option value="oss-cn-huhehaote" {{ 'selected' if rclone_config.get('region') == 'oss-cn-huhehaote' else '' }}>华北5（呼和浩特）</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if config.storage_type == 'cloudflare_r2' %}
                    <!-- Cloudflare R2配置字段 -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Cloudflare R2配置</strong> - 使用S3兼容协议访问Cloudflare R2存储
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="r2_access_key" class="form-label">Access Key ID *</label>
                                <input type="text" class="form-control" id="r2_access_key" name="r2_access_key" 
                                       value="{{ rclone_config.get('access_key_id', '') }}" required>
                                <div class="form-text">R2 API Token的Access Key ID</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="r2_secret_key" class="form-label">Secret Access Key *</label>
                                <input type="password" class="form-control" id="r2_secret_key" name="r2_secret_key" 
                                       value="{{ rclone_config.get('secret_access_key', '') }}" required>
                                <div class="form-text">R2 API Token的Secret Access Key</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="r2_endpoint" class="form-label">Endpoint *</label>
                        <input type="text" class="form-control" id="r2_endpoint" name="r2_endpoint" 
                               value="{{ rclone_config.get('endpoint', '') }}" required
                               placeholder="例如：your-account-id.r2.cloudflarestorage.com">
                        <div class="form-text">R2端点地址，不包含https://前缀</div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>注意：</strong>Cloudflare R2的区域设置为auto，端点格式为：account-id.r2.cloudflarestorage.com
                    </div>
                    {% endif %}

                    {% if config.storage_type == 'ftp' %}
                    <!-- FTP配置字段 -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>FTP配置</strong> - 文件传输协议
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="host" class="form-label">主机地址 *</label>
                                <input type="text" class="form-control" id="host" name="host"
                                       value="{{ rclone_config.get('host', '') }}" required
                                       placeholder="例如：ftp.example.com">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="port" class="form-label">端口</label>
                                <input type="number" class="form-control" id="port" name="port"
                                       value="{{ rclone_config.get('port', '21') }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名 *</label>
                                <input type="text" class="form-control" id="username" name="username"
                                       value="{{ rclone_config.get('user', '') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">密码 *</label>
                                <input type="password" class="form-control" id="password" name="password"
                                       value="{{ rclone_config.get('pass', '') }}" required>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if config.storage_type == 'sftp' %}
                    <!-- SFTP配置字段 -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>SFTP配置</strong> - SSH文件传输协议，支持密码和密钥认证
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="sftp_host" class="form-label">主机地址 *</label>
                                <input type="text" class="form-control" id="sftp_host" name="host"
                                       value="{{ rclone_config.get('host', '') }}" required
                                       placeholder="例如：sftp.example.com">
                                <div class="form-text">SFTP服务器地址</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="sftp_port" class="form-label">端口</label>
                                <input type="number" class="form-control" id="sftp_port" name="port"
                                       value="{{ rclone_config.get('port', '22') }}" min="1" max="65535">
                                <div class="form-text">SSH端口，默认22</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sftp_username" class="form-label">用户名 *</label>
                                <input type="text" class="form-control" id="sftp_username" name="username"
                                       value="{{ rclone_config.get('user', '') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sftp_password" class="form-label">密码</label>
                                <input type="password" class="form-control" id="sftp_password" name="password"
                                       value="{{ rclone_config.get('pass', '') }}"
                                       placeholder="SSH登录密码">
                                <div class="form-text">留空使用密钥认证或ssh-agent</div>
                            </div>
                        </div>
                    </div>
                    <!-- 密钥认证 -->
                    <div class="mb-3">
                        <label class="form-label">密钥认证（可选）</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="sftp_key_file" class="form-label">私钥文件路径</label>
                                <input type="text" class="form-control" id="sftp_key_file" name="key_file"
                                       value="{{ rclone_config.get('key_file', '') }}"
                                       placeholder="例如：~/.ssh/id_rsa">
                                <div class="form-text">PEM格式的私钥文件路径</div>
                            </div>
                            <div class="col-md-6">
                                <label for="sftp_key_pass" class="form-label">私钥密码</label>
                                <input type="password" class="form-control" id="sftp_key_pass" name="key_pass"
                                       value="{{ rclone_config.get('key_pass', '') }}"
                                       placeholder="私钥文件密码">
                                <div class="form-text">如果私钥有密码保护</div>
                            </div>
                        </div>
                    </div>
                    <!-- 高级选项 -->
                    <div class="mb-3">
                        <label class="form-label">高级选项</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use_insecure_cipher" name="use_insecure_cipher"
                                           {{ 'checked' if rclone_config.get('use_insecure_cipher') == 'true' else '' }}>
                                    <label class="form-check-label" for="use_insecure_cipher">
                                        使用不安全的加密算法
                                    </label>
                                    <div class="form-text small">启用aes128-cbc等旧加密算法</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="disable_hashcheck" name="disable_hashcheck"
                                           {{ 'checked' if rclone_config.get('disable_hashcheck') == 'true' else '' }}>
                                    <label class="form-check-label" for="disable_hashcheck">
                                        禁用哈希检查
                                    </label>
                                    <div class="form-text small">禁用远程文件哈希计算</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if config.storage_type == 'google_drive' %}
                    <!-- Google Drive配置字段 -->
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Google Drive配置</strong> - 需要OAuth2授权或服务账户凭据
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="drive_client_id" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="drive_client_id" name="client_id"
                                       value="{{ rclone_config.get('client_id', '') }}"
                                       placeholder="留空使用默认值">
                                <div class="form-text">Google OAuth2 Client ID，留空使用rclone默认值</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="drive_client_secret" class="form-label">Client Secret</label>
                                <input type="password" class="form-control" id="drive_client_secret" name="client_secret"
                                       value="{{ rclone_config.get('client_secret', '') }}"
                                       placeholder="留空使用默认值">
                                <div class="form-text">Google OAuth2 Client Secret，留空使用rclone默认值</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="drive_scope" class="form-label">访问范围</label>
                        <select class="form-select" id="drive_scope" name="scope">
                            <option value="drive" {{ 'selected' if rclone_config.get('scope') == 'drive' else '' }}>完全访问（推荐）</option>
                            <option value="drive.readonly" {{ 'selected' if rclone_config.get('scope') == 'drive.readonly' else '' }}>只读访问</option>
                            <option value="drive.file" {{ 'selected' if rclone_config.get('scope') == 'drive.file' else '' }}>仅访问rclone创建的文件</option>
                            <option value="drive.appfolder" {{ 'selected' if rclone_config.get('scope') == 'drive.appfolder' else '' }}>应用数据文件夹</option>
                            <option value="drive.metadata.readonly" {{ 'selected' if rclone_config.get('scope') == 'drive.metadata.readonly' else '' }}>仅元数据只读</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="drive_root_folder" class="form-label">根文件夹ID</label>
                        <input type="text" class="form-control" id="drive_root_folder" name="root_folder_id"
                               value="{{ rclone_config.get('root_folder_id', '') }}"
                               placeholder="可选，限制访问特定文件夹">
                        <div class="form-text">留空访问整个Drive，或指定文件夹ID限制访问范围</div>
                    </div>
                    <div class="mb-3">
                        <label for="drive_service_account_file" class="form-label">服务账户凭据文件</label>
                        <textarea class="form-control" id="drive_service_account_file" name="service_account_credentials" rows="6"
                                  placeholder="粘贴服务账户JSON凭据内容">{{ rclone_config.get('service_account_credentials', '') }}</textarea>
                        <div class="form-text">从Google Cloud Console下载的服务账户JSON文件内容</div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>提示：</strong>修改OAuth2配置时可能需要重新授权
                    </div>
                    {% endif %}
                </div>

                <!-- 操作按钮 -->
                <div class="form-actions">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('storage_configs') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="testConnection()">
                                <i class="bi bi-wifi me-1"></i>测试连接
                            </button>
                            <button type="submit" class="btn btn-gradient">
                                <i class="bi bi-check-circle me-1"></i>保存更改
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 测试结果模态框 -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-wifi"></i> 连接测试结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testConnection() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // 显示加载状态
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';
    button.disabled = true;
    
    fetch(`/storage-configs/{{ config.id }}/test`)
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('testResult');
            
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> 连接成功！
                        <br><small>${data.message}</small>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> 连接失败
                        <br><small>${data.message}</small>
                    </div>
                `;
            }
            
            new bootstrap.Modal(document.getElementById('testResultModal')).show();
        })
        .catch(error => {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 测试出错
                    <br><small>${error.message}</small>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('testResultModal')).show();
        })
        .finally(() => {
            // 恢复按钮状态
            button.innerHTML = originalText;
            button.disabled = false;
        });
}
</script>
{% endblock %}
