{% extends "base.html" %}

{% block title %}存储配置 - RClone备份系统{% endblock %}

{% block content %}
<div class="page-header-enhanced fade-in-up">
    <div class="container-fluid px-0">
        <div class="row align-items-center">
            <div class="col-lg-8 col-md-7">
                <div class="page-title-section">
                    <div class="page-title-icon">
                        <i class="bi bi-cloud"></i>
                    </div>
                    <div class="page-title-content">
                        <h1 class="page-title mb-1">存储配置</h1>
                        <p class="page-subtitle mb-0">管理云存储服务配置，支持多种存储类型</p>
                        {% if configs %}
                        <div class="page-stats mt-2">
                            <span class="stat-item">
                                <i class="bi bi-cloud-check me-1"></i>
                                <strong>{{ configs|length }}</strong> 个配置
                            </span>
                            <span class="stat-item ms-3">
                                <i class="bi bi-check-circle me-1"></i>
                                <strong>{{ configs|selectattr('is_active')|list|length }}</strong> 个活跃
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-5">
                <div class="page-actions">
                    {% if configs %}
                    <form method="POST" action="{{ url_for('sync_all_storage_configs') }}" class="d-inline">
                        <button type="submit" class="btn btn-outline-warning me-2"
                                onclick="return confirm('确定要同步所有配置吗？这将从rclone配置文件读取最新配置并保存为新版本。')"
                                title="批量同步所有配置">
                            <i class="bi bi-arrow-repeat me-1"></i>
                            <span class="d-none d-sm-inline">批量同步</span>
                        </button>
                    </form>
                    {% endif %}
                    <button type="button" class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addConfigModal">
                        <i class="bi bi-plus-circle me-1"></i>
                        <span>添加配置</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 存储配置列表 -->
<div class="row g-4 fade-in-up" style="animation-delay: 0.2s;">
    {% if configs %}
        {% for config in configs %}
        <div class="col-xl-4 col-lg-6 col-md-6">
            <div class="storage-config-card glass-card h-100 d-flex flex-column">
                <!-- 卡片头部 -->
                <div class="card-header-custom d-flex justify-content-between align-items-start mb-4">
                    <div class="d-flex align-items-center flex-grow-1">
                        <div class="storage-icon-wrapper me-3">
                            {% if config.storage_type == 's3' %}
                                <i class="bi bi-amazon storage-icon" style="color: #ff9900;"></i>
                            {% elif config.storage_type == 'alibaba_oss' %}
                                <i class="bi bi-cloud storage-icon" style="color: #ff6a00;"></i>
                            {% elif config.storage_type == 'cloudflare_r2' %}
                                <i class="bi bi-cloud storage-icon" style="color: #f38020;"></i>
                            {% elif config.storage_type == 'google_drive' %}
                                <i class="bi bi-google storage-icon" style="color: #4285f4;"></i>
                            {% elif config.storage_type == 'ftp' %}
                                <i class="bi bi-hdd-network storage-icon" style="color: #6c757d;"></i>
                            {% elif config.storage_type == 'sftp' %}
                                <i class="bi bi-shield-lock storage-icon" style="color: #198754;"></i>
                            {% else %}
                                <i class="bi bi-cloud storage-icon" style="color: #6c757d;"></i>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1 min-width-0">
                            <h5 class="config-name mb-1">{{ config.name }}</h5>
                            <div class="config-type">
                                {% if config.storage_type == 's3' %}
                                    Amazon S3
                                {% elif config.storage_type == 'alibaba_oss' %}
                                    阿里云 OSS
                                {% elif config.storage_type == 'cloudflare_r2' %}
                                    Cloudflare R2
                                {% elif config.storage_type == 'google_drive' %}
                                    Google Drive
                                {% elif config.storage_type == 'ftp' %}
                                    FTP
                                {% elif config.storage_type == 'sftp' %}
                                    SFTP
                                {% else %}
                                    {{ config.storage_type }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="status-badge">
                        <span class="badge status-{{ 'active' if config.is_active else 'inactive' }}">
                            <i class="bi bi-{{ 'check-circle-fill' if config.is_active else 'pause-circle-fill' }} me-1"></i>
                            {{ '活跃' if config.is_active else '禁用' }}
                        </span>
                    </div>
                </div>

                <!-- 卡片内容 -->
                <div class="card-content flex-grow-1 mb-4">
                    <div class="config-meta mb-3">
                        <div class="meta-item">
                            <i class="bi bi-calendar3 me-2 text-muted"></i>
                            <span class="text-muted">创建于 {{ config.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        {% if config.updated_at != config.created_at %}
                        <div class="meta-item">
                            <i class="bi bi-arrow-clockwise me-2 text-muted"></i>
                            <span class="text-muted">更新于 {{ config.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if config.backup_tasks %}
                    <div class="backup-tasks-info">
                        <div class="info-badge">
                            <i class="bi bi-archive me-2"></i>
                            <span>关联 <strong>{{ config.backup_tasks|length }}</strong> 个备份任务</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if config.description %}
                    <div class="config-description mt-3">
                        <p class="text-muted mb-0">{{ config.description }}</p>
                    </div>
                    {% endif %}
                </div>

                <!-- 操作按钮组 -->
                <div class="card-actions">
                    <div class="action-buttons-primary mb-2">
                        <button type="button"
                                class="btn btn-outline-primary btn-action"
                                onclick="testBackupUpload({{ config.id }})"
                                title="测试备份上传">
                            <i class="bi bi-cloud-upload me-1"></i>
                            <span>测试备份</span>
                        </button>
                        <button type="button"
                                class="btn btn-outline-warning btn-action"
                                onclick="syncConfig({{ config.id }})"
                                title="同步配置">
                            <i class="bi bi-arrow-repeat me-1"></i>
                            <span>同步配置</span>
                        </button>
                    </div>
                    <div class="action-buttons-secondary">
                        <a href="{{ url_for('storage_config_history', config_id=config.id) }}"
                           class="btn btn-outline-info btn-sm btn-action-sm"
                           title="查看历史版本">
                            <i class="bi bi-clock-history me-1"></i>
                            <span>历史版本</span>
                        </a>
                        <a href="{{ url_for('edit_storage_config', config_id=config.id) }}"
                           class="btn btn-outline-primary btn-sm btn-action-sm"
                           title="编辑配置">
                            <i class="bi bi-pencil me-1"></i>
                            <span>编辑</span>
                        </a>
                        <button type="button"
                                class="btn btn-outline-danger btn-sm btn-action-sm"
                                onclick="deleteConfig({{ config.id }}, '{{ config.name }}')"
                                title="删除配置">
                            <i class="bi bi-trash me-1"></i>
                            <span>删除</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="empty-state-card glass-card text-center">
            <div class="empty-state-content">
                <div class="empty-state-icon-wrapper mb-4">
                    <div class="empty-state-icon">
                        <i class="bi bi-cloud-plus"></i>
                    </div>
                    <div class="empty-state-decoration"></div>
                </div>
                <h3 class="empty-state-title mb-3">暂无存储配置</h3>
                <p class="empty-state-description mb-4">
                    开始您的备份之旅！添加第一个存储配置，支持多种云存储服务，
                    <br>让您的数据安全无忧。
                </p>
                <div class="empty-state-actions">
                    <button type="button" class="btn btn-gradient btn-lg" data-bs-toggle="modal" data-bs-target="#addConfigModal">
                        <i class="bi bi-plus-circle me-2"></i>添加存储配置
                    </button>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            支持 S3、阿里云OSS、Google Drive、FTP 等多种存储服务
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- 添加存储配置模态框 -->
<div class="modal fade" id="addConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content modal-modern">
            <div class="modal-header-modern">
                <div class="modal-title-section">
                    <div class="modal-title-icon">
                        <i class="bi bi-cloud-plus"></i>
                    </div>
                    <div class="modal-title-content">
                        <h4 class="modal-title mb-1">添加存储配置</h4>
                        <p class="modal-subtitle mb-0">配置新的云存储服务连接</p>
                    </div>
                </div>
                <button type="button" class="btn-close-modern" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form method="POST" action="{{ url_for('create_storage_config') }}">
                <div class="modal-body-modern">
                    <!-- 基本信息区域 -->
                    <div class="form-section-modal mb-4">
                        <h6 class="form-section-title-modal">
                            <i class="bi bi-info-circle me-2"></i>基本信息
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label-modern">配置名称 *</label>
                                    <input type="text" class="form-control-modern" id="name" name="name" required
                                           placeholder="例如：我的S3存储">
                                    <div class="form-text-modern">用于识别此存储配置的名称</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="storage_type" class="form-label-modern">存储类型 *</label>
                                    <select class="form-select-modern" id="storage_type" name="storage_type" required onchange="showConfigFields()">
                                        <option value="">请选择存储类型</option>
                                        {% for storage_type in storage_types %}
                                        <option value="{{ storage_type.value }}">{{ storage_type.label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="description" class="form-label-modern">描述</label>
                                    <textarea class="form-control-modern" id="description" name="description" rows="2"
                                              placeholder="可选，描述此配置的用途"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="test_path" class="form-label-modern">测试路径</label>
                                    <input type="text" class="form-control-modern" id="test_path" name="test_path"
                                           placeholder="例如：/backup-tests">
                                    <div class="form-text-modern">用于测试备份上传的远程路径</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 配置参数区域 -->
                    <div class="config-parameters-section">
                        <h6 class="form-section-title-modal">
                            <i class="bi bi-gear me-2"></i>配置参数
                        </h6>
                        <div class="config-fields-container">
                    
                    <!-- S3配置字段 -->
                    <div id="s3_fields" class="config-fields" style="display: none;">
                        <div class="config-info-box info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Amazon S3配置</strong> - 支持AWS S3及兼容S3的存储服务
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="access_key" class="form-label-modern">Access Key ID *</label>
                                    <input type="text" class="form-control-modern" id="access_key" name="access_key" data-required="true">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="secret_key" class="form-label-modern">Secret Access Key *</label>
                                    <input type="password" class="form-control-modern" id="secret_key" name="secret_key" data-required="true">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="region" class="form-label-modern">区域</label>
                                    <select class="form-select-modern" id="region" name="region">
                                        <option value="us-east-1">US East (N. Virginia)</option>
                                        <option value="us-west-1">US West (N. California)</option>
                                        <option value="us-west-2">US West (Oregon)</option>
                                        <option value="eu-west-1">Europe (Ireland)</option>
                                        <option value="eu-central-1">Europe (Frankfurt)</option>
                                        <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                                        <option value="ap-northeast-1">Asia Pacific (Tokyo)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endpoint" class="form-label-modern">自定义端点</label>
                                    <input type="text" class="form-control-modern" id="endpoint" name="endpoint"
                                           placeholder="可选，用于S3兼容存储">
                                    <div class="form-text-modern">留空使用AWS S3默认端点</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="bucket" class="form-label-modern">默认存储桶</label>
                            <input type="text" class="form-control-modern" id="bucket" name="bucket"
                                   placeholder="可选，指定默认存储桶">
                        </div>
                    </div>
                    
                    <!-- FTP配置字段 -->
                    <div id="ftp_fields" class="config-fields" style="display: none;">
                        <div class="config-info-box info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>FTP配置</strong> - 文件传输协议，支持标准FTP连接
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="host" class="form-label">主机地址 *</label>
                                    <input type="text" class="form-control" id="host" name="host" data-required="true"
                                           placeholder="例如：ftp.example.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="port" class="form-label">端口</label>
                                    <input type="number" class="form-control" id="port" name="port" value="21">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">用户名 *</label>
                                    <input type="text" class="form-control" id="username" name="username" data-required="true">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="password" class="form-label">密码 *</label>
                                    <input type="password" class="form-control" id="password" name="password" data-required="true">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 阿里云OSS配置字段 -->
                    <div id="alibaba_oss_fields" class="config-fields" style="display: none;">
                        <div class="config-info-box info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>阿里云OSS配置</strong> - 使用S3兼容协议访问阿里云对象存储
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="oss_access_key" class="form-label">Access Key ID *</label>
                                    <input type="text" class="form-control" id="oss_access_key" name="oss_access_key" data-required="true">
                                    <div class="form-text">阿里云AccessKey ID</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="oss_secret_key" class="form-label">Secret Access Key *</label>
                                    <input type="password" class="form-control" id="oss_secret_key" name="oss_secret_key" data-required="true">
                                    <div class="form-text">阿里云AccessKey Secret</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="oss_endpoint" class="form-label">Endpoint *</label>
                                    <input type="text" class="form-control" id="oss_endpoint" name="oss_endpoint" data-required="true"
                                           placeholder="例如：oss-cn-hangzhou.aliyuncs.com">
                                    <div class="form-text">OSS区域端点地址，不包含https://</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="oss_region" class="form-label">区域</label>
                                    <select class="form-select" id="oss_region" name="region">
                                        <option value="oss-cn-hangzhou">华东1（杭州）</option>
                                        <option value="oss-cn-shanghai">华东2（上海）</option>
                                        <option value="oss-cn-beijing">华北2（北京）</option>
                                        <option value="oss-cn-shenzhen">华南1（深圳）</option>
                                        <option value="oss-cn-guangzhou">华南2（广州）</option>
                                        <option value="oss-cn-chengdu">西南1（成都）</option>
                                        <option value="oss-cn-qingdao">华北1（青岛）</option>
                                        <option value="oss-cn-zhangjiakou">华北3（张家口）</option>
                                        <option value="oss-cn-huhehaote">华北5（呼和浩特）</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cloudflare R2配置字段 -->
                    <div id="cloudflare_r2_fields" class="config-fields" style="display: none;">
                        <div class="config-info-box info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Cloudflare R2配置</strong> - 使用S3兼容协议访问Cloudflare R2存储
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="r2_access_key" class="form-label">Access Key ID *</label>
                                    <input type="text" class="form-control" id="r2_access_key" name="r2_access_key" data-required="true">
                                    <div class="form-text">R2 API Token的Access Key ID</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="r2_secret_key" class="form-label">Secret Access Key *</label>
                                    <input type="password" class="form-control" id="r2_secret_key" name="r2_secret_key" data-required="true">
                                    <div class="form-text">R2 API Token的Secret Access Key</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="r2_endpoint" class="form-label">Endpoint *</label>
                            <input type="text" class="form-control" id="r2_endpoint" name="r2_endpoint" data-required="true"
                                   placeholder="例如：your-account-id.r2.cloudflarestorage.com">
                            <div class="form-text">R2端点地址，不包含https://前缀</div>
                        </div>
                        <div class="config-info-box warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>注意：</strong>Cloudflare R2的区域设置为auto，端点格式为：account-id.r2.cloudflarestorage.com
                        </div>
                    </div>

                    <!-- Google Drive配置字段 -->
                    <div id="google_drive_fields" class="config-fields" style="display: none;">
                        <div class="config-info-box warning mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Google Drive配置</strong> - 需要OAuth2授权或服务账户凭据
                        </div>

                        <!-- 授权方式选择 -->
                        <div class="mb-3">
                            <label class="form-label">授权方式</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="drive_auth_type" id="drive_oauth" value="oauth" checked>
                                <label class="form-check-label" for="drive_oauth">
                                    OAuth2授权（推荐）
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="drive_auth_type" id="drive_service_account" value="service_account">
                                <label class="form-check-label" for="drive_service_account">
                                    服务账户
                                </label>
                            </div>
                        </div>

                        <!-- OAuth2配置 -->
                        <div id="drive_oauth_config">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="drive_client_id" class="form-label">Client ID</label>
                                        <input type="text" class="form-control" id="drive_client_id" name="client_id"
                                               placeholder="留空使用默认值">
                                        <div class="form-text">Google OAuth2 Client ID，留空使用rclone默认值</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="drive_client_secret" class="form-label">Client Secret</label>
                                        <input type="password" class="form-control" id="drive_client_secret" name="client_secret"
                                               placeholder="留空使用默认值">
                                        <div class="form-text">Google OAuth2 Client Secret，留空使用rclone默认值</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="drive_scope" class="form-label">访问范围</label>
                                <select class="form-select" id="drive_scope" name="scope">
                                    <option value="drive">完全访问（推荐）</option>
                                    <option value="drive.readonly">只读访问</option>
                                    <option value="drive.file">仅访问rclone创建的文件</option>
                                    <option value="drive.appfolder">应用数据文件夹</option>
                                    <option value="drive.metadata.readonly">仅元数据只读</option>
                                </select>
                            </div>
                        </div>

                        <!-- 服务账户配置 -->
                        <div id="drive_service_account_config" style="display: none;">
                            <div class="mb-3">
                                <label for="drive_service_account_file" class="form-label">服务账户凭据文件</label>
                                <textarea class="form-control" id="drive_service_account_file" name="service_account_credentials" rows="8"
                                          placeholder="粘贴服务账户JSON凭据内容"></textarea>
                                <div class="form-text">从Google Cloud Console下载的服务账户JSON文件内容</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="drive_root_folder" class="form-label">根文件夹ID</label>
                            <input type="text" class="form-control" id="drive_root_folder" name="root_folder_id"
                                   placeholder="可选，限制访问特定文件夹">
                            <div class="form-text">留空访问整个Drive，或指定文件夹ID限制访问范围</div>
                        </div>

                        <div class="config-info-box info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>提示：</strong>首次配置OAuth2时需要在浏览器中完成授权流程
                        </div>
                    </div>

                    <!-- SFTP配置字段 -->
                    <div id="sftp_fields" class="config-fields" style="display: none;">
                        <div class="config-info-box info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>SFTP配置</strong> - SSH文件传输协议，支持密码和密钥认证
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="sftp_host" class="form-label">主机地址 *</label>
                                    <input type="text" class="form-control" id="sftp_host" name="host" data-required="true"
                                           placeholder="例如：sftp.example.com">
                                    <div class="form-text">SFTP服务器地址</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sftp_port" class="form-label">端口</label>
                                    <input type="number" class="form-control" id="sftp_port" name="port" value="22" min="1" max="65535">
                                    <div class="form-text">SSH端口，默认22</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sftp_username" class="form-label">用户名 *</label>
                                    <input type="text" class="form-control" id="sftp_username" name="username" data-required="true">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sftp_password" class="form-label">密码</label>
                                    <input type="password" class="form-control" id="sftp_password" name="password"
                                           placeholder="SSH登录密码">
                                    <div class="form-text">留空使用密钥认证或ssh-agent</div>
                                </div>
                            </div>
                        </div>

                        <!-- 密钥认证 -->
                        <div class="mb-3">
                            <label class="form-label">密钥认证（可选）</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="sftp_key_file" class="form-label">私钥文件路径</label>
                                    <input type="text" class="form-control" id="sftp_key_file" name="key_file"
                                           placeholder="例如：~/.ssh/id_rsa">
                                    <div class="form-text">PEM格式的私钥文件路径</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="sftp_key_pass" class="form-label">私钥密码</label>
                                    <input type="password" class="form-control" id="sftp_key_pass" name="key_pass"
                                           placeholder="私钥文件密码">
                                    <div class="form-text">如果私钥有密码保护</div>
                                </div>
                            </div>
                        </div>

                        <!-- 高级选项 -->
                        <div class="mb-3">
                            <label class="form-label">高级选项</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="use_insecure_cipher" name="use_insecure_cipher">
                                        <label class="form-check-label" for="use_insecure_cipher">
                                            使用不安全的加密算法
                                        </label>
                                        <div class="form-text small">启用aes128-cbc等旧加密算法</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="disable_hashcheck" name="disable_hashcheck">
                                        <label class="form-check-label" for="disable_hashcheck">
                                            禁用哈希检查
                                        </label>
                                        <div class="form-text small">禁用远程文件哈希计算</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer-modern">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="modal-footer-info">
                            <small class="text-muted">
                                <i class="bi bi-shield-check me-1"></i>
                                配置将自动进行连接测试验证
                            </small>
                        </div>
                        <div class="modal-footer-actions">
                            <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-1"></i>取消
                            </button>
                            <button type="submit" class="btn btn-gradient" onclick="return validateForm()">
                                <i class="bi bi-check-circle me-1"></i>创建配置
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 测试结果模态框 -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload"></i> 备份测试结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showConfigFields() {
    const storageType = document.getElementById('storage_type').value;
    const allFields = document.querySelectorAll('.config-fields');

    // 隐藏所有配置字段并移除required属性
    allFields.forEach(field => {
        field.classList.remove('show');
        setTimeout(() => {
            field.style.display = 'none';
        }, 300);

        // 移除所有隐藏字段的required属性
        const requiredInputs = field.querySelectorAll('input[required], select[required]');
        requiredInputs.forEach(input => {
            input.removeAttribute('required');
        });
    });

    // 显示对应的配置字段并添加required属性
    let targetFieldId = '';
    if (storageType === 's3') {
        targetFieldId = 's3_fields';
    } else if (storageType === 'alibaba_oss') {
        targetFieldId = 'alibaba_oss_fields';
    } else if (storageType === 'cloudflare_r2') {
        targetFieldId = 'cloudflare_r2_fields';
    } else if (storageType === 'google_drive') {
        targetFieldId = 'google_drive_fields';
    } else if (storageType === 'sftp') {
        targetFieldId = 'sftp_fields';
    } else if (storageType === 'ftp') {
        targetFieldId = 'ftp_fields';
    }

    if (targetFieldId) {
        const targetField = document.getElementById(targetFieldId);
        const container = document.querySelector('.config-fields-container');

        if (targetField && container) {
            // 将字段移动到容器中
            container.appendChild(targetField);

            setTimeout(() => {
                targetField.style.display = 'block';
                setTimeout(() => {
                    targetField.classList.add('show');
                }, 50);
            }, 300);

            // 为显示的字段添加required属性
            const requiredInputs = targetField.querySelectorAll('input[data-required="true"], select[data-required="true"]');
            requiredInputs.forEach(input => {
                input.setAttribute('required', 'required');
            });
        }
    }
}

// 表单验证函数
function validateForm() {
    const storageType = document.getElementById('storage_type').value;
    const name = document.getElementById('config_name').value.trim();

    // 检查基本字段
    if (!name) {
        alert('请填写配置名称');
        return false;
    }

    if (!storageType) {
        alert('请选择存储类型');
        return false;
    }

    // 根据存储类型验证必填字段
    if (storageType === 'cloudflare_r2') {
        const accessKey = document.getElementById('r2_access_key').value.trim();
        const secretKey = document.getElementById('r2_secret_key').value.trim();
        const endpoint = document.getElementById('r2_endpoint').value.trim();

        if (!accessKey) {
            alert('请填写 Cloudflare R2 的 Access Key ID');
            document.getElementById('r2_access_key').focus();
            return false;
        }

        if (!secretKey) {
            alert('请填写 Cloudflare R2 的 Secret Access Key');
            document.getElementById('r2_secret_key').focus();
            return false;
        }

        if (!endpoint) {
            alert('请填写 Cloudflare R2 的 Endpoint');
            document.getElementById('r2_endpoint').focus();
            return false;
        }

        console.log('Cloudflare R2 validation passed:', {
            accessKey: accessKey,
            secretKey: secretKey ? '***' : '',
            endpoint: endpoint
        });
    } else if (storageType === 'alibaba_oss') {
        const accessKey = document.getElementById('oss_access_key').value.trim();
        const secretKey = document.getElementById('oss_secret_key').value.trim();
        const endpoint = document.getElementById('oss_endpoint').value.trim();

        if (!accessKey) {
            alert('请填写阿里云OSS的Access Key ID');
            document.getElementById('oss_access_key').focus();
            return false;
        }

        if (!secretKey) {
            alert('请填写阿里云OSS的Secret Access Key');
            document.getElementById('oss_secret_key').focus();
            return false;
        }

        if (!endpoint) {
            alert('请填写阿里云OSS的Endpoint');
            document.getElementById('oss_endpoint').focus();
            return false;
        }
    } else if (storageType === 's3') {
        const accessKey = document.getElementById('access_key').value.trim();
        const secretKey = document.getElementById('secret_key').value.trim();

        if (!accessKey) {
            alert('请填写S3的Access Key ID');
            document.getElementById('access_key').focus();
            return false;
        }

        if (!secretKey) {
            alert('请填写S3的Secret Access Key');
            document.getElementById('secret_key').focus();
            return false;
        }
    }

    return true;
}

// Google Drive授权方式切换
function toggleDriveAuthType() {
    const oauthRadio = document.getElementById('drive_oauth');
    const serviceAccountRadio = document.getElementById('drive_service_account');
    const oauthConfig = document.getElementById('drive_oauth_config');
    const serviceAccountConfig = document.getElementById('drive_service_account_config');

    if (oauthRadio && oauthRadio.checked) {
        oauthConfig.style.display = 'block';
        serviceAccountConfig.style.display = 'none';
    } else if (serviceAccountRadio && serviceAccountRadio.checked) {
        oauthConfig.style.display = 'none';
        serviceAccountConfig.style.display = 'block';
    }
}

// 页面加载完成后绑定事件
document.addEventListener('DOMContentLoaded', function() {
    // 绑定Google Drive授权方式切换事件
    const driveOauthRadio = document.getElementById('drive_oauth');
    const driveServiceAccountRadio = document.getElementById('drive_service_account');

    if (driveOauthRadio) {
        driveOauthRadio.addEventListener('change', toggleDriveAuthType);
    }
    if (driveServiceAccountRadio) {
        driveServiceAccountRadio.addEventListener('change', toggleDriveAuthType);
    }
});



function testBackupUpload(configId) {
    const button = event.target;
    const originalText = button.innerHTML;

    // 显示加载状态
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';
    button.disabled = true;

    fetch(`/storage-configs/${configId}/test-backup`)
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('testResult');

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> 备份测试成功！
                        <br><small>${data.message}</small>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> 备份测试失败
                        <br><small>${data.message}</small>
                    </div>
                `;
            }

            new bootstrap.Modal(document.getElementById('testResultModal')).show();
        })
        .catch(error => {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 测试出错
                    <br><small>${error.message}</small>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('testResultModal')).show();
        })
        .finally(() => {
            // 恢复按钮状态
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function syncConfig(configId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;

    // 显示加载状态
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    button.disabled = true;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/storage-configs/${configId}/sync`;
    document.body.appendChild(form);
    form.submit();
}

function deleteConfig(configId, configName) {
    if (confirmDelete(`确定要删除存储配置"${configName}"吗？`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/storage-configs/${configId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
