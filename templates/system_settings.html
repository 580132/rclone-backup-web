{% extends "base.html" %}

{% block title %}系统设置 - RClone备份系统{% endblock %}

{% block extra_css %}
<style>
/* 系统设置页面专用样式 */
.settings-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    padding: 2rem;
    margin-bottom: 2rem;
    transition: var(--transition);
}

.settings-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.settings-section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
}

.settings-section-title i {
    margin-right: 0.75rem;
    color: #000000;
    font-size: 1.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-item {
    background: rgba(248, 249, 250, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: var(--border-radius-sm);
    padding: 1.25rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-light);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #000000;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.form-section {
    background: rgba(248, 249, 250, 0.5);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: var(--border-radius-sm);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-section:last-child {
    margin-bottom: 0;
}

.form-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
}

.form-section-title i {
    margin-right: 0.5rem;
    color: #000000;
}

.password-form .form-group {
    margin-bottom: 1.25rem;
}

.password-form .form-group:last-child {
    margin-bottom: 0;
}

.password-form .form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.password-form .form-control {
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius-sm);
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
    background: white;
}

.password-form .form-control:focus {
    border-color: #000000;
    box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
}

.export-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius);
    padding: 2rem;
    text-align: center;
}

.export-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #000000 0%, #434343 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    color: white;
    font-size: 2rem;
    box-shadow: var(--shadow-light);
}

.export-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

.export-description {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.user-info-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.user-avatar {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #000000 0%, #434343 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin-right: 1rem;
    flex-shrink: 0;
}

.user-details h5 {
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.user-details .text-muted {
    font-size: 0.875rem;
}

.password-strength {
    margin-top: 0.5rem;
}

.password-strength-bar {
    height: 4px;
    border-radius: 2px;
    background: rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 0.25rem;
}

.password-strength-fill {
    height: 100%;
    transition: all 0.3s ease;
    border-radius: 2px;
}

.password-strength-text {
    font-size: 0.75rem;
    font-weight: 500;
}

.strength-weak .password-strength-fill {
    width: 33%;
    background: #dc3545;
}

.strength-weak .password-strength-text {
    color: #dc3545;
}

.strength-medium .password-strength-fill {
    width: 66%;
    background: #ffc107;
}

.strength-medium .password-strength-text {
    color: #ffc107;
}

.strength-strong .password-strength-fill {
    width: 100%;
    background: #28a745;
}

.strength-strong .password-strength-text {
    color: #28a745;
}

.info-item code {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    color: #495057;
    word-break: break-all;
}

.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    border-radius: 12px;
    font-weight: 600;
}

.info-grid .info-item {
    margin-bottom: 1rem;
}

.info-grid .info-item:last-child {
    margin-bottom: 0;
}

.maintenance-options {
    margin-top: 1rem;
}

.maintenance-option {
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius-sm);
    padding: 1rem;
    margin-bottom: 1rem;
    background: rgba(248, 249, 250, 0.5);
}

.maintenance-option:last-child {
    margin-bottom: 0;
}

.maintenance-option h6 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.maintenance-option p {
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .settings-card {
        padding: 1.5rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .stat-item {
        padding: 1rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .export-section {
        padding: 1.5rem;
    }
    
    .export-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
    
    .user-info-section {
        padding: 1rem;
    }
    
    .user-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center fade-in-up">
    <div>
        <h1 class="page-title">
            <i class="bi bi-gear"></i>系统设置
        </h1>
        <p class="text-muted mb-0">管理系统配置和用户设置</p>
    </div>
</div>

<!-- 系统统计 -->
<div class="settings-card fade-in-up" style="animation-delay: 0.1s;">
    <h3 class="settings-section-title">
        <i class="bi bi-bar-chart"></i>系统统计
    </h3>
    
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-number">{{ stats.total_users }}</div>
            <div class="stat-label">用户总数</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ stats.active_storage_configs }}</div>
            <div class="stat-label">活跃存储配置</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ stats.active_backup_tasks }}</div>
            <div class="stat-label">活跃备份任务</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ stats.successful_backups }}</div>
            <div class="stat-label">成功备份</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ stats.failed_backups }}</div>
            <div class="stat-label">失败备份</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ stats.running_backups }}</div>
            <div class="stat-label">运行中备份</div>
        </div>
    </div>
</div>

<!-- 用户设置 -->
<div class="settings-card fade-in-up" style="animation-delay: 0.2s;">
    <h3 class="settings-section-title">
        <i class="bi bi-person-gear"></i>用户设置
    </h3>
    
    <!-- 当前用户信息 -->
    <div class="user-info-section">
        <div class="d-flex align-items-center">
            <div class="user-avatar">
                <i class="bi bi-person"></i>
            </div>
            <div class="user-details">
                <h5>{{ current_user.username }}</h5>
                <p class="text-muted mb-0">
                    注册时间: {{ current_user.created_at.strftime('%Y-%m-%d %H:%M:%S') if current_user.created_at else '未知' }}
                </p>
            </div>
        </div>
    </div>
    
    <!-- 修改密码 -->
    <div class="form-section">
        <div class="form-section-title">
            <i class="bi bi-key"></i>修改密码
        </div>
        
        <form method="POST" action="{{ url_for('change_password') }}" class="password-form">
            <div class="form-group">
                <label for="old_password" class="form-label">当前密码</label>
                <input type="password" class="form-control" id="old_password" name="old_password" required>
            </div>
            
            <div class="form-group">
                <label for="new_password" class="form-label">新密码</label>
                <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                <div class="password-strength" id="passwordStrength" style="display: none;">
                    <div class="password-strength-bar">
                        <div class="password-strength-fill"></div>
                    </div>
                    <div class="password-strength-text"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="confirm_password" class="form-label">确认新密码</label>
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="6">
            </div>
            
            <button type="submit" class="btn btn-gradient">
                <i class="bi bi-check-circle me-2"></i>修改密码
            </button>
        </form>
    </div>
</div>

<!-- 系统信息 -->
<div class="settings-card fade-in-up" style="animation-delay: 0.3s;">
    <h3 class="settings-section-title">
        <i class="bi bi-info-circle"></i>系统信息
    </h3>

    <div class="row">
        <div class="col-md-6">
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-cpu"></i>系统环境
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">系统版本</div>
                        <div class="info-value">{{ system_info.version }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Python版本</div>
                        <div class="info-value">{{ system_info.python_version }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">运行平台</div>
                        <div class="info-value">{{ system_info.platform }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">调试模式</div>
                        <div class="info-value">
                            {% if system_info.debug_mode %}
                                <span class="badge bg-warning">开启</span>
                            {% else %}
                                <span class="badge bg-success">关闭</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-folder"></i>配置路径
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">数据库路径</div>
                        <div class="info-value">
                            <code>{{ system_info.database_path }}</code>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">RClone配置目录</div>
                        <div class="info-value">
                            <code>{{ system_info.rclone_config_dir }}</code>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">临时文件目录</div>
                        <div class="info-value">
                            <code>{{ system_info.backup_temp_dir }}</code>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">日志文件</div>
                        <div class="info-value">
                            <code>{{ system_info.log_file }}</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据管理 -->
<div class="settings-card fade-in-up" style="animation-delay: 0.4s;">
    <h3 class="settings-section-title">
        <i class="bi bi-database"></i>数据管理
    </h3>

    <div class="row">
        <div class="col-md-4">
            <div class="export-section">
                <div class="export-icon">
                    <i class="bi bi-download"></i>
                </div>
                <h4 class="export-title">导出系统数据</h4>
                <p class="export-description">
                    导出包含完整存储配置和敏感数据的加密文件。
                </p>
                <a href="{{ url_for('export_system_data') }}" class="btn btn-gradient">
                    <i class="bi bi-cloud-download me-2"></i>导出数据
                </a>
            </div>
        </div>

        <div class="col-md-4">
            <div class="export-section">
                <div class="export-icon" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <i class="bi bi-upload"></i>
                </div>
                <h4 class="export-title">导入系统数据</h4>
                <p class="export-description">
                    从加密的导出文件恢复系统配置和数据。
                </p>
                <a href="{{ url_for('import_system_data') }}" class="btn btn-outline-success">
                    <i class="bi bi-cloud-upload me-2"></i>导入数据
                </a>
            </div>
        </div>

        <div class="col-md-4">
            <div class="export-section">
                <div class="export-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h4 class="export-title">系统维护</h4>
                <p class="export-description">
                    执行系统清理和维护操作，请谨慎使用。
                </p>
                <button type="button" class="btn btn-outline-danger" onclick="showMaintenanceModal()">
                    <i class="bi bi-tools me-2"></i>维护选项
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 系统维护模态框 -->
<div class="modal fade" id="maintenanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-tools me-2"></i>系统维护
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>警告：</strong>以下操作可能会影响系统正常运行，请确保您了解操作的后果。
                </div>

                <div class="maintenance-options">
                    <div class="maintenance-option">
                        <h6><i class="bi bi-journal-x me-2"></i>清理系统日志</h6>
                        <p class="text-muted">删除30天前的备份日志记录，释放数据库空间。</p>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="cleanupLogs()">
                            <i class="bi bi-trash me-1"></i>清理日志
                        </button>
                    </div>

                    <div class="maintenance-option">
                        <h6><i class="bi bi-arrow-clockwise me-2"></i>重启调度器</h6>
                        <p class="text-muted">重新启动备份任务调度器，解决调度问题。</p>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="restartScheduler()">
                            <i class="bi bi-arrow-clockwise me-1"></i>重启调度器
                        </button>
                    </div>

                    <div class="maintenance-option">
                        <h6><i class="bi bi-folder-x me-2"></i>清理临时文件</h6>
                        <p class="text-muted">删除备份过程中产生的临时文件。</p>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cleanupTempFiles()">
                            <i class="bi bi-folder-x me-1"></i>清理文件
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 密码强度检测
function checkPasswordStrength(password) {
    const strengthElement = document.getElementById('passwordStrength');
    const fillElement = strengthElement.querySelector('.password-strength-fill');
    const textElement = strengthElement.querySelector('.password-strength-text');
    
    if (password.length === 0) {
        strengthElement.style.display = 'none';
        return;
    }
    
    strengthElement.style.display = 'block';
    
    let score = 0;
    
    // 长度检查
    if (password.length >= 8) score += 1;
    if (password.length >= 12) score += 1;
    
    // 复杂度检查
    if (/[a-z]/.test(password)) score += 1;
    if (/[A-Z]/.test(password)) score += 1;
    if (/[0-9]/.test(password)) score += 1;
    if (/[^A-Za-z0-9]/.test(password)) score += 1;
    
    // 移除所有强度类
    strengthElement.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
    
    if (score <= 2) {
        strengthElement.classList.add('strength-weak');
        textElement.textContent = '弱';
    } else if (score <= 4) {
        strengthElement.classList.add('strength-medium');
        textElement.textContent = '中等';
    } else {
        strengthElement.classList.add('strength-strong');
        textElement.textContent = '强';
    }
}

// 密码确认检查
function checkPasswordMatch() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const confirmInput = document.getElementById('confirm_password');
    
    if (confirmPassword.length === 0) {
        confirmInput.classList.remove('is-valid', 'is-invalid');
        return;
    }
    
    if (newPassword === confirmPassword) {
        confirmInput.classList.remove('is-invalid');
        confirmInput.classList.add('is-valid');
    } else {
        confirmInput.classList.remove('is-valid');
        confirmInput.classList.add('is-invalid');
    }
}

// 绑定事件
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });
    
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    
    // 表单提交验证
    document.querySelector('.password-form').addEventListener('submit', function(e) {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showNotification('新密码和确认密码不匹配', 'error');
            return false;
        }
        
        if (newPassword.length < 6) {
            e.preventDefault();
            showNotification('密码长度至少为6位', 'error');
            return false;
        }
    });
});

// 系统维护功能
function showMaintenanceModal() {
    const modal = new bootstrap.Modal(document.getElementById('maintenanceModal'));
    modal.show();
}

function cleanupLogs() {
    if (confirm('确定要清理30天前的备份日志吗？此操作不可撤销。')) {
        showNotification('日志清理功能开发中...', 'info');
    }
}

function restartScheduler() {
    if (confirm('确定要重启调度器吗？这可能会影响正在运行的备份任务。')) {
        showNotification('调度器重启功能开发中...', 'info');
    }
}

function cleanupTempFiles() {
    if (confirm('确定要清理临时文件吗？')) {
        showNotification('临时文件清理功能开发中...', 'info');
    }
}
</script>
{% endblock %}
