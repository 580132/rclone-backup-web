{% extends "base.html" %}

{% block title %}备份日志详情 - RClone备份系统{% endblock %}

{% block extra_css %}
<style>
/* 日志详情页面专用样式 */
.log-detail-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    padding: 2rem;
    margin-bottom: 2rem;
}

.log-status-large {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
}

.log-status-large.status-running {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    animation: pulse 2s infinite;
}

.log-status-large.status-success {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

.log-status-large.status-failed {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.info-item {
    background: rgba(248, 249, 250, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: var(--border-radius-sm);
    padding: 1.25rem;
    transition: all 0.3s ease;
}

.info-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-light);
}

.info-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.info-label i {
    margin-right: 0.5rem;
    color: #000000;
}

.info-value {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    word-break: break-all;
}

.info-value.large {
    font-size: 1.5rem;
}

.progress-info {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.progress-bar-custom {
    height: 8px;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.log-details-section {
    background: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-top: 2rem;
}

.log-content {
    background: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius-sm);
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
}

.error-message {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 1px solid #fecaca;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.error-message .error-title {
    color: #dc2626;
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
}

.error-message .error-title i {
    margin-right: 0.5rem;
}

.error-message .error-content {
    color: #991b1b;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
}

.task-link {
    color: #000000;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
}

.task-link:hover {
    color: #000000;
    text-decoration: underline;
}

.task-link i {
    margin-left: 0.5rem;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* 响应式调整 */
@media (max-width: 768px) {
    .log-detail-card {
        padding: 1.5rem;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .info-item {
        padding: 1rem;
    }
    
    .info-value {
        font-size: 1rem;
    }
    
    .info-value.large {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center fade-in-up">
    <div>
        <h1 class="page-title">
            <i class="bi bi-file-text"></i>备份日志详情
        </h1>
        <p class="text-muted mb-0">查看备份任务的详细执行信息</p>
    </div>
    <div>
        <a href="{{ url_for('backup_logs') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-2"></i>返回列表
        </a>
        {% if log.status == 'running' %}
        <button type="button" class="btn btn-gradient" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-2"></i>刷新状态
        </button>
        {% endif %}
    </div>
</div>

<!-- 基本信息 -->
<div class="log-detail-card fade-in-up" style="animation-delay: 0.1s;">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h3 class="mb-2">
                {% if log.task %}
                <a href="{{ url_for('backup_tasks') }}" class="task-link">
                    {{ log.task.name }}
                    <i class="bi bi-box-arrow-up-right"></i>
                </a>
                {% else %}
                未知任务
                {% endif %}
            </h3>
            <p class="text-muted mb-3">任务ID: {{ log.task_id }} | 日志ID: {{ log.id }}</p>
        </div>
        <div>
            <span class="log-status-large status-{{ log.status }}">
                {% if log.status == 'running' %}
                    <i class="bi bi-arrow-clockwise me-2"></i>运行中
                {% elif log.status == 'success' %}
                    <i class="bi bi-check-circle me-2"></i>执行成功
                {% elif log.status == 'failed' %}
                    <i class="bi bi-x-circle me-2"></i>执行失败
                {% endif %}
            </span>
        </div>
    </div>

    <!-- 信息网格 -->
    <div class="info-grid">
        <div class="info-item">
            <div class="info-label">
                <i class="bi bi-clock"></i>开始时间
            </div>
            <div class="info-value">
                {{ log.start_time.strftime('%Y-%m-%d %H:%M:%S') if log.start_time else '-' }}
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">
                <i class="bi bi-clock-history"></i>结束时间
            </div>
            <div class="info-value">
                {% if log.end_time %}
                    {{ log.end_time.strftime('%Y-%m-%d %H:%M:%S') }}
                {% elif log.status == 'running' %}
                    <span class="text-warning">进行中...</span>
                {% else %}
                    -
                {% endif %}
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">
                <i class="bi bi-stopwatch"></i>执行时长
            </div>
            <div class="info-value large">
                {% if log.duration %}
                    {{ log.duration }}
                {% elif log.status == 'running' %}
                    <span class="text-warning">进行中...</span>
                {% else %}
                    -
                {% endif %}
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">
                <i class="bi bi-hdd"></i>原始大小
            </div>
            <div class="info-value">
                {% if log.original_size %}
                    {{ (log.original_size / 1024 / 1024) | round(2) }} MB
                {% else %}
                    -
                {% endif %}
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">
                <i class="bi bi-archive"></i>压缩后大小
            </div>
            <div class="info-value">
                {% if log.compressed_size %}
                    {{ (log.compressed_size / 1024 / 1024) | round(2) }} MB
                {% else %}
                    -
                {% endif %}
            </div>
        </div>

        <div class="info-item">
            <div class="info-label">
                <i class="bi bi-cloud-upload"></i>最终大小
            </div>
            <div class="info-value">
                {% if log.final_size %}
                    {{ (log.final_size / 1024 / 1024) | round(2) }} MB
                {% else %}
                    -
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 压缩比信息 -->
    {% if log.compression_ratio > 0 %}
    <div class="progress-info">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold">压缩效果</span>
            <span class="badge bg-success fs-6">节省 {{ log.compression_ratio }}%</span>
        </div>
        <div class="progress-bar-custom">
            <div class="progress-fill" style="width: {{ log.compression_ratio }}%"></div>
        </div>
        <small class="text-muted">
            原始大小 {{ (log.original_size / 1024 / 1024) | round(2) }} MB → 
            压缩后 {{ (log.compressed_size / 1024 / 1024) | round(2) }} MB
        </small>
    </div>
    {% endif %}
</div>

<!-- 错误信息 -->
{% if log.error_message %}
<div class="error-message fade-in-up" style="animation-delay: 0.2s;">
    <div class="error-title">
        <i class="bi bi-exclamation-triangle"></i>错误信息
    </div>
    <div class="error-content">{{ log.error_message }}</div>
</div>
{% endif %}

<!-- 详细日志 -->
{% if log.log_details %}
<div class="log-details-section fade-in-up" style="animation-delay: 0.3s;">
    <h5 class="mb-3">
        <i class="bi bi-terminal me-2"></i>详细日志
    </h5>
    <div class="log-content">{{ log.log_details }}</div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 如果任务正在运行，自动刷新页面
{% if log.status == 'running' %}
setTimeout(function() {
    location.reload();
}, 30000); // 30秒后刷新
{% endif %}
</script>
{% endblock %}
