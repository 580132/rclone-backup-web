{% extends "base.html" %}

{% block title %}
    {% if task %}编辑备份任务{% else %}创建备份任务{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面头部 -->
    <div class="page-header fade-in-down">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    {% if task %}
                        <i class="bi bi-pencil-square"></i> 编辑备份任务
                    {% else %}
                        <i class="bi bi-plus-circle"></i> 创建备份任务
                    {% endif %}
                </h1>
                <p class="page-subtitle">
                    {% if task %}
                        修改备份任务的配置信息
                    {% else %}
                        配置新的备份任务
                    {% endif %}
                </p>
            </div>
            <div class="page-actions">
                <a href="{{ url_for('backup_tasks') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 返回任务列表
                </a>
            </div>
        </div>
    </div>

    <!-- 表单 -->
    <div class="row justify-content-center fade-in-up" style="animation-delay: 0.2s;">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear"></i> 任务配置
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{% if task %}{{ url_for('update_backup_task', task_id=task.id) }}{% else %}{{ url_for('create_backup_task') }}{% endif %}" onsubmit="return validateForm()">
                        <!-- 基本信息 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-info-circle me-2"></i>基本信息
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="task_name" class="form-label">任务名称 *</label>
                                        <input type="text" class="form-control" id="task_name" name="name" 
                                               value="{{ task.name if task else '' }}" required placeholder="例如：每日文档备份">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">存储配置 *</label>
                                        <div class="storage-configs-container">
                                            <div class="form-text mb-2">选择一个或多个存储位置进行备份</div>
                                            <div class="selected-storage-configs mb-3" id="selectedStorageConfigs" style="display: none;">
                                                <div class="d-flex flex-wrap gap-2" id="selectedStorageTags"></div>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="openStorageConfigModal()">
                                                <i class="bi bi-plus-circle me-1"></i>选择存储配置
                                            </button>
                                            <div class="form-text mt-1">点击按钮选择存储配置并设置远程路径</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="description" class="form-label">任务描述</label>
                                        <textarea class="form-control" id="description" name="description" rows="2"
                                                  placeholder="可选：描述这个备份任务的用途">{{ task.description or '' if task else '' }}</textarea>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">任务状态</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                                   {% if task %}{% if task.is_active %}checked{% endif %}{% else %}checked{% endif %}>
                                            <label class="form-check-label" for="is_active">
                                                <i class="bi bi-power me-1"></i>启用任务
                                            </label>
                                        </div>
                                        <div class="form-text">禁用后任务将不会自动执行</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 路径配置 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-folder me-2"></i>路径配置
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="source_path" class="form-label">源路径 *</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="source_path" name="source_path" 
                                                   value="{{ task.source_path if task else '' }}" required placeholder="/home/user/documents">
                                            <button class="btn btn-outline-secondary" type="button" onclick="showDirectoryBrowser()">
                                                <i class="bi bi-folder"></i> 浏览
                                            </button>
                                        </div>
                                        <div class="form-text">要备份的文件或目录的完整路径</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 调度设置 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-clock me-2"></i>调度设置
                            </h6>

                            <!-- 定时类型选择 -->
                            <div class="mb-3">
                                <div class="row g-2">
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_manual" value="manual"
                                               {% if task %}{% if not task.cron_expression %}checked{% endif %}{% else %}checked{% endif %}>
                                        <label class="btn btn-outline-primary w-100" for="schedule_manual">
                                            <i class="bi bi-hand-index me-1"></i>手动执行
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_daily" value="daily">
                                        <label class="btn btn-outline-primary w-100" for="schedule_daily">
                                            <i class="bi bi-calendar-day me-1"></i>每日
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_weekly" value="weekly">
                                        <label class="btn btn-outline-primary w-100" for="schedule_weekly">
                                            <i class="bi bi-calendar-week me-1"></i>每周
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_monthly" value="monthly">
                                        <label class="btn btn-outline-primary w-100" for="schedule_monthly">
                                            <i class="bi bi-calendar-month me-1"></i>每月
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 每日设置 -->
                            <div id="daily_settings" class="schedule-settings" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="daily_time" class="form-label">执行时间</label>
                                        <input type="time" class="form-control" id="daily_time" value="02:00">
                                        <div class="form-text">每天在此时间执行备份</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 每周设置 -->
                            <div id="weekly_settings" class="schedule-settings" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">执行日期</label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_1" value="1">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_1">周一</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_2">周二</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_3" value="3">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_3">周三</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_4" value="4">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_4">周四</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_5" value="5">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_5">周五</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_6" value="6">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_6">周六</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_0">周日</label>
                                            </div>
                                        </div>
                                        <div class="form-text mt-2">选择一周中的哪几天执行备份</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="weekly_time" class="form-label">执行时间</label>
                                        <input type="time" class="form-control" id="weekly_time" value="02:00">
                                        <div class="form-text">在选定日期的此时间执行</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 每月设置 -->
                            <div id="monthly_settings" class="schedule-settings" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="monthly_day" class="form-label">执行日期</label>
                                        <select class="form-select" id="monthly_day">
                                            <option value="1" selected>1日</option>
                                            <option value="2">2日</option>
                                            <option value="3">3日</option>
                                            <option value="4">4日</option>
                                            <option value="5">5日</option>
                                            <option value="10">10日</option>
                                            <option value="15">15日</option>
                                            <option value="20">20日</option>
                                            <option value="25">25日</option>
                                            <option value="28">28日</option>
                                            <option value="-1">月末</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="monthly_time" class="form-label">执行时间</label>
                                        <input type="time" class="form-control" id="monthly_time" value="02:00">
                                    </div>
                                </div>
                                <div class="form-text mt-2">每月在指定日期和时间执行备份</div>
                            </div>

                            <!-- 高级设置切换 -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show_advanced_cron">
                                    <label class="form-check-label" for="show_advanced_cron">
                                        <i class="bi bi-gear me-1"></i>显示高级Cron设置
                                    </label>
                                </div>
                            </div>

                            <!-- Cron表达式输入 (高级模式) -->
                            <div id="advanced_cron_settings" style="display: none;" class="mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="cron_expression" name="cron_expression"
                                           value="{{ task.cron_expression or '' if task else '' }}" placeholder="0 2 * * *" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="showCronHelper()">
                                        <i class="bi bi-question-circle"></i>
                                    </button>
                                </div>
                                <div class="form-text">当前生成的Cron表达式，可手动修改</div>
                            </div>

                            <!-- 预览信息 -->
                            <div id="schedule_preview" class="mt-3">
                                <div class="alert alert-info d-flex align-items-center">
                                    <i class="bi bi-info-circle me-2 flex-shrink-0"></i>
                                    <span id="schedule_preview_text" class="mb-0">当前设置为手动执行，不会自动运行备份任务</span>
                                </div>
                            </div>
                        </div>

                        <!-- 备份选项 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-gear me-2"></i>备份选项
                            </h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="compression_enabled"
                                               name="compression_enabled" {% if task %}{% if task.compression_enabled %}checked{% endif %}{% else %}checked{% endif %}
                                               onchange="toggleCompression()">
                                        <label class="form-check-label" for="compression_enabled">
                                            <i class="bi bi-file-zip me-1"></i>启用压缩
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="encryption_enabled"
                                               name="encryption_enabled" {% if task %}{% if task.encryption_enabled %}checked{% endif %}{% endif %}
                                               onchange="toggleEncryption()">
                                        <label class="form-check-label" for="encryption_enabled">
                                            <i class="bi bi-shield-lock me-1"></i>启用加密
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3" id="compression_options" {% if task %}{% if not task.compression_enabled %}style="display: none;"{% endif %}{% endif %}>
                                        <label for="compression_type" class="form-label">压缩格式</label>
                                        <select class="form-select" id="compression_type" name="compression_type">
                                            <option value="tar.gz" {% if task %}{% if task.compression_type == 'tar.gz' %}selected{% endif %}{% else %}selected{% endif %}>tar.gz (推荐)</option>
                                            <option value="zip" {% if task %}{% if task.compression_type == 'zip' %}selected{% endif %}{% endif %}>zip</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3" id="encryption_options" {% if task %}{% if not task.encryption_enabled %}style="display: none;"{% endif %}{% else %}style="display: none;"{% endif %}>
                                        <label for="encryption_password" class="form-label">加密密码</label>
                                        <input type="password" class="form-control" id="encryption_password"
                                               name="encryption_password" {% if task %}placeholder="留空保持原密码不变"{% else %}placeholder="设置加密密码"{% endif %}>
                                        {% if task %}
                                        <div class="form-text">留空表示保持原有密码不变</div>
                                        {% else %}
                                        <div class="form-text">请设置一个强密码来保护备份文件</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 保留策略 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-archive me-2"></i>保留策略
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="retention_count" class="form-label">保留备份数量</label>
                                        <input type="number" class="form-control" id="retention_count" name="retention_count"
                                               value="{{ task.retention_count if task else 10 }}" min="1" max="100">
                                        <div class="form-text">保留最近的N个备份文件，超出的会被自动删除</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('backup_tasks') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                            <button type="submit" class="btn btn-primary">
                                {% if task %}
                                    <i class="bi bi-check-circle"></i> 保存更改
                                {% else %}
                                    <i class="bi bi-plus-circle"></i> 创建任务
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 存储配置选择弹窗 -->
<div class="modal fade" id="storageConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud me-2"></i>选择存储配置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-text mb-3">选择一个或多个存储位置，并为每个位置设置远程路径</div>
                <div class="storage-config-selection">
                    {% for config in storage_configs %}
                    <div class="storage-config-option mb-3 p-3 border rounded" data-config-id="{{ config.id }}">
                        <div class="form-check">
                            <input class="form-check-input storage-modal-checkbox" type="checkbox"
                                   id="modal_storage_config_{{ config.id }}"
                                   value="{{ config.id }}"
                                   onchange="toggleModalStorageConfig({{ config.id }})">
                            <label class="form-check-label fw-medium d-flex align-items-center" for="modal_storage_config_{{ config.id }}">
                                <i class="bi bi-cloud me-2"></i>
                                <div>
                                    <div>{{ config.name }}</div>
                                    <small class="text-muted">{{ config.storage_type }}</small>
                                </div>
                            </label>
                        </div>
                        <div class="storage-modal-path mt-3" id="modal_path_container_{{ config.id }}" style="display: none;">
                            <label for="modal_remote_path_{{ config.id }}" class="form-label">远程路径</label>
                            <input type="text" class="form-control"
                                   id="modal_remote_path_{{ config.id }}"
                                   placeholder="例如：backup/documents">
                            <div class="form-text">在此存储位置的备份路径</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmStorageSelection()">确认选择</button>
            </div>
        </div>
    </div>
</div>

<!-- 目录浏览器模态框 -->
<div class="modal fade" id="directoryBrowserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder"></i> 选择目录
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex align-items-center">
                        <span class="me-2">当前路径:</span>
                        <code id="currentPath">/</code>
                    </div>
                </div>
                <div id="directoryTree">
                    <div class="text-center py-3">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="selectCurrentPath()">选择当前路径</button>
            </div>
        </div>
    </div>
</div>

<!-- Cron帮助模态框 -->
<div class="modal fade" id="cronHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cron表达式帮助</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Cron表达式格式：<code>分 时 日 月 周</code></p>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>字段</th>
                                <th>允许值</th>
                                <th>特殊字符</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>分</td><td>0-59</td><td>, - * /</td></tr>
                            <tr><td>时</td><td>0-23</td><td>, - * /</td></tr>
                            <tr><td>日</td><td>1-31</td><td>, - * ? / L W</td></tr>
                            <tr><td>月</td><td>1-12</td><td>, - * /</td></tr>
                            <tr><td>周</td><td>0-7</td><td>, - * ? / L #</td></tr>
                        </tbody>
                    </table>
                </div>
                <h6>常用示例：</h6>
                <ul class="list-unstyled">
                    <li><code>0 2 * * *</code> - 每天凌晨2点</li>
                    <li><code>0 */6 * * *</code> - 每6小时</li>
                    <li><code>0 0 * * 0</code> - 每周日午夜</li>
                    <li><code>0 0 1 * *</code> - 每月1号午夜</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/backup_task_form.js') }}"></script>

<script>
// 初始化存储配置（编辑模式）
{% if task %}
    {% if task.task_storage_configs %}
        const taskStorageConfigs = [
            {% for task_storage_config in task.task_storage_configs %}
                {
                    storage_config_id: {{ task_storage_config.storage_config_id }},
                    remote_path: '{{ task_storage_config.remote_path }}'
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        initializeStorageConfigs(taskStorageConfigs);
    {% elif task.storage_config_id and task.remote_path %}
        // 向后兼容：加载旧的单存储配置
        initializeStorageConfigs(null, {{ task.storage_config_id }}, '{{ task.remote_path }}');
    {% endif %}
{% endif %}
</script>

<style>
.directory-tree {
    max-height: 400px;
    overflow-y: auto;
}

.directory-item {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
}

.directory-item:hover {
    background-color: #f8f9fa;
}

.directory-item.selected {
    background-color: #e3f2fd;
    color: #1976d2;
}

.directory-item i {
    margin-right: 0.5rem;
    width: 16px;
}

.file-item {
    opacity: 0.6;
    cursor: default;
}

.file-item:hover {
    background-color: transparent;
}

/* 存储配置标签样式 */
.selected-storage-configs .badge {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    max-width: 300px;
}

.selected-storage-configs .badge .fw-medium {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.selected-storage-configs .badge small {
    font-size: 0.75rem;
    opacity: 0.9;
}

.storage-config-option {
    transition: all 0.3s ease;
}

.storage-config-option:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}
</style>
{% endblock %}
