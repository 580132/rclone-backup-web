{% extends "base.html" %}

{% block title %}调度器状态 - RClone备份系统{% endblock %}

{% block extra_css %}
<style>
/* 调度器状态页面专用样式 */
.scheduler-status-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    transition: var(--transition);
    overflow: hidden;
}

.scheduler-status-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
    animation: pulse 2s infinite;
}

.status-indicator.running {
    background: #28a745;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
}

.status-indicator.stopped {
    background: #ffc107;
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
}

.status-indicator.error {
    background: #dc3545;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
}

.jobs-table {
    background: white;
    border-radius: var(--border-radius-sm);
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.jobs-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: none;
    font-weight: 600;
    color: var(--text-primary);
    padding: 1rem 0.75rem;
}

.jobs-table td {
    border: none;
    padding: 0.75rem;
    vertical-align: middle;
}

.jobs-table tbody tr {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: background-color 0.2s ease;
}

.jobs-table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.last-update-info {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius-sm);
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center fade-in-up">
    <div>
        <h1 class="page-title">
            <i class="bi bi-clock-history"></i>调度器状态
        </h1>
        <p class="text-muted mb-0">实时查看调度器运行状态和作业信息</p>
    </div>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-2"></i>返回仪表板
        </a>
        <button type="button" class="btn btn-gradient" onclick="refreshStatus()">
            <i class="bi bi-arrow-clockwise me-2"></i>刷新状态
        </button>
    </div>
</div>

<!-- 最后更新时间 -->
<div class="mb-4 fade-in-up" style="animation-delay: 0.1s;">
    <div class="last-update-info">
        <i class="bi bi-clock me-2"></i>
        <span id="last-update">正在加载...</span>
    </div>
</div>
<!-- 状态统计卡片 -->
<div class="row g-4 mb-5 fade-in-up" style="animation-delay: 0.2s;">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-label">调度器状态</div>
                    <div class="stat-number d-flex align-items-center">
                        <span class="status-indicator" id="scheduler-indicator"></span>
                        <span id="scheduler-status">检查中...</span>
                    </div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-gear-fill" id="scheduler-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card success h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-label">作业数量</div>
                    <div class="stat-number" id="jobs-count" style="color: #28a745;">-</div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-list-task"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card warning h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-label">活跃任务</div>
                    <div class="stat-number" id="active-tasks-count" style="color: #ffc107;">-</div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-folder-fill"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-label">应用实例</div>
                    <div class="stat-number" id="app-instance-status">-</div>
                </div>
                <div class="stat-icon">
                    <i class="bi bi-app"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 作业列表 -->
<div class="row fade-in-up" style="animation-delay: 0.4s;">
    <div class="col-12">
        <div class="glass-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle me-3"
                         style="width: 50px; height: 50px; background: #000000;">
                        <i class="bi bi-list-ul text-white"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold" style="color: #000000;">调度器作业</h4>
                        <p class="text-muted mb-0">当前调度器中的所有作业</p>
                    </div>
                </div>
            </div>
            <div id="jobs-list">
                <div class="d-flex justify-content-center py-4">
                    <div class="loading-spinner me-2"></div>
                    <span class="text-muted">加载中...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务列表 -->
<div class="row fade-in-up" style="animation-delay: 0.6s;">
    <div class="col-12">
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle me-3"
                         style="width: 50px; height: 50px; background: #000000;">
                        <i class="bi bi-folder-check text-white"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold" style="color: #000000;">备份任务</h4>
                        <p class="text-muted mb-0">活跃的备份任务及其调度状态</p>
                    </div>
                </div>
            </div>
            <div id="tasks-list">
                <div class="d-flex justify-content-center py-4">
                    <div class="loading-spinner me-2"></div>
                    <span class="text-muted">加载中...</span>
                </div>
            </div>
        </div>
    </div>
</div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
<script>
function refreshStatus() {
    fetch('/scheduler-status')
        .then(response => response.json())
        .then(data => {
            updateStatus(data);
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('获取状态失败: ' + error.message, 'error');
        });
}

function updateStatus(data) {
    // 更新时间
    document.getElementById('last-update').textContent = '最后更新: ' + new Date().toLocaleString();

    // 更新调度器状态
    const schedulerIcon = document.getElementById('scheduler-icon');
    const schedulerStatus = document.getElementById('scheduler-status');
    const schedulerIndicator = document.getElementById('scheduler-indicator');

    if (data.error) {
        schedulerIcon.className = 'bi bi-exclamation-triangle-fill';
        schedulerStatus.textContent = '错误';
        schedulerIndicator.className = 'status-indicator error';
        showNotification('调度器错误: ' + data.error, 'error');
        return;
    }

    if (data.scheduler_running) {
        schedulerIcon.className = 'bi bi-gear-fill';
        schedulerStatus.textContent = '运行中';
        schedulerIndicator.className = 'status-indicator running';
    } else if (data.scheduler_exists) {
        schedulerIcon.className = 'bi bi-gear-fill';
        schedulerStatus.textContent = '已停止';
        schedulerIndicator.className = 'status-indicator stopped';
    } else {
        schedulerIcon.className = 'bi bi-gear-fill';
        schedulerStatus.textContent = '未初始化';
        schedulerIndicator.className = 'status-indicator error';
    }

    // 更新计数
    document.getElementById('jobs-count').textContent = data.jobs.length;
    document.getElementById('active-tasks-count').textContent = data.active_tasks.length;
    document.getElementById('app-instance-status').textContent = data.app_instance_set ? '已设置' : '未设置';

    // 更新作业列表
    const jobsList = document.getElementById('jobs-list');
    if (data.jobs.length === 0) {
        jobsList.innerHTML = `
            <div class="empty-state-card text-center">
                <div class="empty-state-content">
                    <div class="empty-state-icon-wrapper mb-4">
                        <div class="empty-state-icon">
                            <i class="bi bi-list-ul"></i>
                        </div>
                        <div class="empty-state-decoration"></div>
                    </div>
                    <h5 class="text-muted mb-2">暂无调度器作业</h5>
                    <p class="text-muted mb-0">调度器中还没有任何作业</p>
                </div>
            </div>
        `;
    } else {
        let jobsHtml = '<div class="table-responsive"><table class="jobs-table table"><thead><tr><th>作业ID</th><th>名称</th><th>下次运行</th><th>函数</th></tr></thead><tbody>';
        data.jobs.forEach(job => {
            jobsHtml += `<tr>
                <td><code class="bg-light px-2 py-1 rounded">${job.id}</code></td>
                <td class="fw-medium">${job.name}</td>
                <td>${job.next_run_time ? new Date(job.next_run_time).toLocaleString() : '<span class="text-muted">未设置</span>'}</td>
                <td><code class="bg-light px-2 py-1 rounded">${job.func_name}</code></td>
            </tr>`;
        });
        jobsHtml += '</tbody></table></div>';
        jobsList.innerHTML = jobsHtml;
    }

    // 更新任务列表
    const tasksList = document.getElementById('tasks-list');
    if (data.active_tasks.length === 0) {
        tasksList.innerHTML = `
            <div class="empty-state-card text-center">
                <div class="empty-state-content">
                    <div class="empty-state-icon-wrapper mb-4">
                        <div class="empty-state-icon">
                            <i class="bi bi-folder-check"></i>
                        </div>
                        <div class="empty-state-decoration"></div>
                    </div>
                    <h5 class="text-muted mb-2">暂无活跃任务</h5>
                    <p class="text-muted mb-0">没有活跃的备份任务</p>
                </div>
            </div>
        `;
    } else {
        let tasksHtml = '<div class="table-responsive"><table class="jobs-table table"><thead><tr><th>任务ID</th><th>名称</th><th>Cron表达式</th><th>下次运行</th><th>调度器作业</th></tr></thead><tbody>';
        data.active_tasks.forEach(task => {
            const statusBadge = task.has_scheduler_job ?
                '<span class="status-badge status-success">已添加</span>' :
                '<span class="status-badge status-error">缺失</span>';

            tasksHtml += `<tr>
                <td class="fw-medium">${task.id}</td>
                <td class="fw-medium">${task.name}</td>
                <td><code class="bg-light px-2 py-1 rounded">${task.cron_expression || '无'}</code></td>
                <td>${task.next_run_at ? new Date(task.next_run_at).toLocaleString() : '<span class="text-muted">未设置</span>'}</td>
                <td>${statusBadge}</td>
            </tr>`;
        });
        tasksHtml += '</tbody></table></div>';
        tasksList.innerHTML = tasksHtml;
    }
}

// 页面加载时获取状态
document.addEventListener('DOMContentLoaded', function() {
    refreshStatus();

    // 每30秒自动刷新
    setInterval(refreshStatus, 30000);
});
</script>
{% endblock %}
