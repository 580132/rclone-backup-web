{% extends "base.html" %}

{% block title %}备份日志 - RClone备份系统{% endblock %}

{% block extra_css %}
<style>
/* 备份日志页面专用样式 */
.log-status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

.log-status-badge.status-running {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    animation: pulse 2s infinite;
}

.log-status-badge.status-success {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
}

.log-status-badge.status-failed {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.log-table {
    background: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-light);
}

.log-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: none;
    font-weight: 600;
    color: var(--text-primary);
    padding: 1rem 0.75rem;
    white-space: nowrap;
}

.log-table td {
    border: none;
    padding: 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.log-table tbody tr {
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.log-table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.log-table tbody tr:last-child td {
    border-bottom: none;
}

.filter-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.size-info {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.duration-info {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.task-name-link {
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s ease;
}

.task-name-link:hover {
    color: #000000;
    text-decoration: underline;
}

.pagination-modern .page-link {
    border: none;
    color: var(--text-secondary);
    background: transparent;
    padding: 0.5rem 0.75rem;
    margin: 0 0.125rem;
    border-radius: var(--border-radius-sm);
    transition: all 0.2s ease;
}

.pagination-modern .page-link:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
}

.pagination-modern .page-item.active .page-link {
    background: var(--primary-gradient);
    color: white;
    box-shadow: var(--shadow-light);
}

.filter-form .form-select,
.filter-form .form-control {
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius-sm);
    padding: 0.5rem 0.75rem;
    transition: all 0.2s ease;
}

.filter-form .form-select:focus,
.filter-form .form-control:focus {
    border-color: #000000;
    box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center fade-in-up">
    <div>
        <h1 class="page-title">
            <i class="bi bi-clock-history"></i>备份日志
        </h1>
        <p class="text-muted mb-0">查看和管理备份任务的执行记录</p>
    </div>
    <div>
        <button type="button" class="btn btn-gradient" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-2"></i>刷新数据
        </button>
    </div>
</div>

<!-- 筛选器 -->
<div class="filter-card fade-in-up" style="animation-delay: 0.1s;">
    <form method="GET" class="filter-form">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="task_id" class="form-label">备份任务</label>
                <select name="task_id" id="task_id" class="form-select">
                    <option value="">全部任务</option>
                    {% for task in tasks %}
                    <option value="{{ task.id }}" {% if current_task_id == task.id %}selected{% endif %}>
                        {{ task.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">执行状态</label>
                <select name="status" id="status" class="form-select">
                    <option value="">全部状态</option>
                    <option value="running" {% if current_status == 'running' %}selected{% endif %}>运行中</option>
                    <option value="success" {% if current_status == 'success' %}selected{% endif %}>成功</option>
                    <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>失败</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="per_page" class="form-label">每页显示</label>
                <select name="per_page" id="per_page" class="form-select">
                    <option value="20" {% if request.args.get('per_page', '20') == '20' %}selected{% endif %}>20条</option>
                    <option value="50" {% if request.args.get('per_page', '20') == '50' %}selected{% endif %}>50条</option>
                    <option value="100" {% if request.args.get('per_page', '20') == '100' %}selected{% endif %}>100条</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-gradient w-100">
                    <i class="bi bi-funnel me-2"></i>筛选
                </button>
            </div>
        </div>
    </form>
</div>

<!-- 日志列表 -->
<div class="row fade-in-up" style="animation-delay: 0.2s;">
    <div class="col-12">
        <div class="glass-card">
            {% if logs.items %}
            <div class="table-responsive">
                <table class="log-table table mb-0">
                    <thead>
                        <tr>
                            <th>任务名称</th>
                            <th>状态</th>
                            <th>开始时间</th>
                            <th>执行时长</th>
                            <th>文件大小</th>
                            <th>压缩比</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs.items %}
                        <tr data-log-id="{{ log.id }}" onclick="window.location.href='{{ url_for('backup_log_detail', log_id=log.id) }}'">
                            <td>
                                <a href="{{ url_for('backup_log_detail', log_id=log.id) }}" class="task-name-link">
                                    {{ log.task.name if log.task else '未知任务' }}
                                </a>
                            </td>
                            <td>
                                <span class="log-status-badge status-{{ log.status }}">
                                    {% if log.status == 'running' %}
                                        <i class="bi bi-arrow-clockwise me-1"></i>运行中
                                    {% elif log.status == 'success' %}
                                        <i class="bi bi-check-circle me-1"></i>成功
                                    {% elif log.status == 'failed' %}
                                        <i class="bi bi-x-circle me-1"></i>失败
                                    {% endif %}
                                </span>
                            </td>
                            <td class="end-time">
                                <div>{{ log.start_time.strftime('%Y-%m-%d %H:%M:%S') if log.start_time else '-' }}</div>
                                {% if log.end_time %}
                                <small class="text-muted">{{ log.end_time.strftime('%H:%M:%S') }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="duration-info">
                                    {% if log.duration %}
                                        {{ log.duration }}
                                    {% elif log.status == 'running' %}
                                        <i class="bi bi-arrow-clockwise"></i> 进行中
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if log.original_size %}
                                <div class="size-info">
                                    <div>原始: {{ (log.original_size / 1024 / 1024) | round(2) }} MB</div>
                                    {% if log.final_size %}
                                    <div>最终: {{ (log.final_size / 1024 / 1024) | round(2) }} MB</div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.compression_ratio > 0 %}
                                <span class="badge bg-success">{{ log.compression_ratio }}%</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('backup_log_detail', log_id=log.id) }}" 
                                   class="btn btn-sm btn-outline-primary"
                                   onclick="event.stopPropagation()">
                                    <i class="bi bi-eye"></i> 详情
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            {% if logs.pages > 1 %}
            <div class="d-flex justify-content-between align-items-center mt-4 px-3 pb-3">
                <div class="text-muted">
                    显示第 {{ logs.per_page * (logs.page - 1) + 1 }} - {{ logs.per_page * (logs.page - 1) + logs.items|length }} 条，
                    共 {{ logs.total }} 条记录
                </div>
                <nav>
                    <ul class="pagination pagination-modern mb-0">
                        {% if logs.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('backup_logs', page=logs.prev_num, task_id=current_task_id, status=current_status, per_page=request.args.get('per_page', 20)) }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in logs.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != logs.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('backup_logs', page=page_num, task_id=current_task_id, status=current_status, per_page=request.args.get('per_page', 20)) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if logs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('backup_logs', page=logs.next_num, task_id=current_task_id, status=current_status, per_page=request.args.get('per_page', 20)) }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <!-- 空状态 -->
            <div class="empty-state-card text-center">
                <div class="empty-state-content">
                    <div class="empty-state-icon-wrapper mb-4">
                        <div class="empty-state-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="empty-state-decoration"></div>
                    </div>
                    <h5 class="text-muted mb-2">暂无备份日志</h5>
                    <p class="text-muted mb-0">还没有任何备份任务的执行记录</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let refreshInterval = null;

// 实时更新运行中的日志状态
function startRealTimeUpdates() {
    const runningRows = document.querySelectorAll('.status-running');
    if (runningRows.length > 0) {
        // 如果有运行中的任务，每5秒更新一次状态
        refreshInterval = setInterval(() => {
            updateRunningLogStatus();
        }, 5000);

        // 显示实时更新指示器
        showRealTimeIndicator();
    }
}

// 更新运行中日志的状态
function updateRunningLogStatus() {
    const runningRows = document.querySelectorAll('.status-running');

    if (runningRows.length === 0) {
        // 没有运行中的任务，停止更新
        stopRealTimeUpdates();
        return;
    }

    // 获取所有运行中的日志ID
    const runningLogIds = Array.from(runningRows).map(row => {
        return row.closest('tr').dataset.logId;
    }).filter(id => id);

    if (runningLogIds.length === 0) {
        return;
    }

    // 批量检查状态
    fetch('/api/backup-logs/status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            log_ids: runningLogIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let hasChanges = false;

            data.logs.forEach(logInfo => {
                const row = document.querySelector(`tr[data-log-id="${logInfo.id}"]`);
                if (row) {
                    const statusBadge = row.querySelector('.log-status-badge');
                    const endTimeCell = row.querySelector('.end-time');

                    if (logInfo.status !== 'running') {
                        // 状态已改变，更新显示
                        hasChanges = true;

                        // 更新状态徽章
                        statusBadge.className = `log-status-badge status-${logInfo.status}`;
                        statusBadge.textContent = logInfo.status === 'success' ? '成功' : '失败';

                        // 更新结束时间
                        if (logInfo.end_time) {
                            endTimeCell.textContent = new Date(logInfo.end_time).toLocaleString();
                        }

                        // 如果失败，显示错误信息
                        if (logInfo.status === 'failed' && logInfo.error_message) {
                            const errorCell = row.querySelector('.error-message');
                            if (errorCell) {
                                errorCell.textContent = logInfo.error_message;
                            }
                        }

                        // 移除运行中的类
                        statusBadge.classList.remove('status-running');
                    }
                }
            });

            if (hasChanges) {
                // 显示更新通知
                showUpdateNotification('日志状态已更新');

                // 检查是否还有运行中的任务
                const stillRunning = document.querySelectorAll('.status-running');
                if (stillRunning.length === 0) {
                    stopRealTimeUpdates();
                }
            }
        }
    })
    .catch(error => {
        console.error('Failed to update log status:', error);
    });
}

// 停止实时更新
function stopRealTimeUpdates() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    hideRealTimeIndicator();
}

// 显示实时更新指示器
function showRealTimeIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'realtime-indicator';
    indicator.className = 'position-fixed bg-primary text-white px-3 py-2 rounded';
    indicator.style.cssText = 'top: 20px; right: 20px; z-index: 9999; font-size: 0.875rem;';
    indicator.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>实时更新中...';
    document.body.appendChild(indicator);
}

// 隐藏实时更新指示器
function hideRealTimeIndicator() {
    const indicator = document.getElementById('realtime-indicator');
    if (indicator) {
        indicator.remove();
    }
}

// 显示更新通知
function showUpdateNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 70px; right: 20px; z-index: 9998; min-width: 250px;';
    notification.innerHTML = `
        <i class="bi bi-info-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // 自动移除通知
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// 页面加载完成后开始实时更新
document.addEventListener('DOMContentLoaded', function() {
    startRealTimeUpdates();
});

// 页面卸载时清理
window.addEventListener('beforeunload', function() {
    stopRealTimeUpdates();
});
</script>
{% endblock %}
