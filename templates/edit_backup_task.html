{% extends "base.html" %}

{% block title %}编辑备份任务{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面头部 -->
    <div class="page-header fade-in-down">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-pencil-square"></i> 编辑备份任务
                </h1>
                <p class="page-subtitle">修改备份任务的配置信息</p>
            </div>
            <div class="page-actions">
                <a href="{{ url_for('backup_tasks') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 返回任务列表
                </a>
            </div>
        </div>
    </div>

    <!-- 编辑表单 -->
    <div class="row justify-content-center fade-in-up" style="animation-delay: 0.2s;">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear"></i> 任务配置
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" onsubmit="return validateForm()">
                        <!-- 基本信息 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-info-circle me-2"></i>基本信息
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="task_name" class="form-label">任务名称 *</label>
                                        <input type="text" class="form-control" id="task_name" name="name" 
                                               value="{{ task.name }}" required placeholder="例如：每日文档备份">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="storage_config_id" class="form-label">存储配置 *</label>
                                        <select class="form-select" id="storage_config_id" name="storage_config_id" required>
                                            <option value="">请选择存储配置</option>
                                            {% for config in storage_configs %}
                                            <option value="{{ config.id }}" 
                                                    {% if config.id == task.storage_config_id %}selected{% endif %}>
                                                {{ config.name }} ({{ config.storage_type }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="description" class="form-label">任务描述</label>
                                        <textarea class="form-control" id="description" name="description" rows="2"
                                                  placeholder="可选：描述这个备份任务的用途">{{ task.description or '' }}</textarea>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">任务状态</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                                   {% if task.is_active %}checked{% endif %}>
                                            <label class="form-check-label" for="is_active">
                                                <i class="bi bi-power me-1"></i>启用任务
                                            </label>
                                        </div>
                                        <div class="form-text">禁用后任务将不会自动执行</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 路径配置 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-folder me-2"></i>路径配置
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="source_path" class="form-label">源路径 *</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="source_path" name="source_path" 
                                                   value="{{ task.source_path }}" required placeholder="/home/user/documents">
                                            <button class="btn btn-outline-secondary" type="button" onclick="showDirectoryBrowser()">
                                                <i class="bi bi-folder"></i> 浏览
                                            </button>
                                        </div>
                                        <div class="form-text">要备份的文件或目录的完整路径</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="remote_path" class="form-label">远程路径 *</label>
                                        <input type="text" class="form-control" id="remote_path" name="remote_path" 
                                               value="{{ task.remote_path }}" required placeholder="backups/documents">
                                        <div class="form-text">在云存储中的保存路径</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 调度设置 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-clock me-2"></i>调度设置
                            </h6>

                            <!-- 定时类型选择 -->
                            <div class="mb-3">
                                <div class="row g-2">
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_manual" value="manual"
                                               {% if not task.cron_expression %}checked{% endif %}>
                                        <label class="btn btn-outline-primary w-100" for="schedule_manual">
                                            <i class="bi bi-hand-index me-1"></i>手动执行
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_daily" value="daily">
                                        <label class="btn btn-outline-primary w-100" for="schedule_daily">
                                            <i class="bi bi-calendar-day me-1"></i>每日
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_weekly" value="weekly">
                                        <label class="btn btn-outline-primary w-100" for="schedule_weekly">
                                            <i class="bi bi-calendar-week me-1"></i>每周
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" class="btn-check" name="schedule_type" id="schedule_monthly" value="monthly">
                                        <label class="btn btn-outline-primary w-100" for="schedule_monthly">
                                            <i class="bi bi-calendar-month me-1"></i>每月
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 每日设置 -->
                            <div id="daily_settings" class="schedule-settings" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="daily_time" class="form-label">执行时间</label>
                                        <input type="time" class="form-control" id="daily_time" value="02:00">
                                        <div class="form-text">每天在此时间执行备份</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 每周设置 -->
                            <div id="weekly_settings" class="schedule-settings" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">执行日期</label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_1" value="1">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_1">周一</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_2">周二</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_3" value="3">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_3">周三</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_4" value="4">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_4">周四</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_5" value="5">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_5">周五</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_6" value="6">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_6">周六</label>
                                            </div>
                                            <div class="col-6">
                                                <input type="checkbox" class="btn-check" id="week_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm w-100" for="week_0">周日</label>
                                            </div>
                                        </div>
                                        <div class="form-text mt-2">选择一周中的哪几天执行备份</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="weekly_time" class="form-label">执行时间</label>
                                        <input type="time" class="form-control" id="weekly_time" value="02:00">
                                        <div class="form-text">在选定日期的此时间执行</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 每月设置 -->
                            <div id="monthly_settings" class="schedule-settings" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="monthly_day" class="form-label">执行日期</label>
                                        <select class="form-select" id="monthly_day">
                                            <option value="1" selected>1日</option>
                                            <option value="2">2日</option>
                                            <option value="3">3日</option>
                                            <option value="4">4日</option>
                                            <option value="5">5日</option>
                                            <option value="10">10日</option>
                                            <option value="15">15日</option>
                                            <option value="20">20日</option>
                                            <option value="25">25日</option>
                                            <option value="28">28日</option>
                                            <option value="-1">月末</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="monthly_time" class="form-label">执行时间</label>
                                        <input type="time" class="form-control" id="monthly_time" value="02:00">
                                    </div>
                                </div>
                                <div class="form-text mt-2">每月在指定日期和时间执行备份</div>
                            </div>

                            <!-- 高级设置切换 -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show_advanced_cron">
                                    <label class="form-check-label" for="show_advanced_cron">
                                        <i class="bi bi-gear me-1"></i>显示高级Cron设置
                                    </label>
                                </div>
                            </div>

                            <!-- Cron表达式输入 (高级模式) -->
                            <div id="advanced_cron_settings" style="display: none;" class="mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="cron_expression" name="cron_expression"
                                           value="{{ task.cron_expression or '' }}" placeholder="0 2 * * *" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="showCronHelper()">
                                        <i class="bi bi-question-circle"></i>
                                    </button>
                                </div>
                                <div class="form-text">当前生成的Cron表达式，可手动修改</div>
                            </div>

                            <!-- 预览信息 -->
                            <div id="schedule_preview" class="mt-3">
                                <div class="alert alert-info d-flex align-items-center">
                                    <i class="bi bi-info-circle me-2 flex-shrink-0"></i>
                                    <span id="schedule_preview_text" class="mb-0">当前设置为手动执行，不会自动运行备份任务</span>
                                </div>
                            </div>
                        </div>

                        <!-- 备份选项 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-gear me-2"></i>备份选项
                            </h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="compression_enabled"
                                               name="compression_enabled" {% if task.compression_enabled %}checked{% endif %} 
                                               onchange="toggleCompression()">
                                        <label class="form-check-label" for="compression_enabled">
                                            <i class="bi bi-file-zip me-1"></i>启用压缩
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="encryption_enabled"
                                               name="encryption_enabled" {% if task.encryption_enabled %}checked{% endif %} 
                                               onchange="toggleEncryption()">
                                        <label class="form-check-label" for="encryption_enabled">
                                            <i class="bi bi-shield-lock me-1"></i>启用加密
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3" id="compression_options" {% if not task.compression_enabled %}style="display: none;"{% endif %}>
                                        <label for="compression_type" class="form-label">压缩格式</label>
                                        <select class="form-select" id="compression_type" name="compression_type">
                                            <option value="tar.gz" {% if task.compression_type == 'tar.gz' %}selected{% endif %}>tar.gz (推荐)</option>
                                            <option value="zip" {% if task.compression_type == 'zip' %}selected{% endif %}>zip</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3" id="encryption_options" {% if not task.encryption_enabled %}style="display: none;"{% endif %}>
                                        <label for="encryption_password" class="form-label">加密密码</label>
                                        <input type="password" class="form-control" id="encryption_password" 
                                               name="encryption_password" placeholder="留空保持原密码不变">
                                        <div class="form-text">留空表示保持原有密码不变</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 保留策略 -->
                        <div class="mb-4">
                            <h6 class="fw-medium mb-3">
                                <i class="bi bi-archive me-2"></i>保留策略
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="retention_count" class="form-label">保留备份数量</label>
                                        <input type="number" class="form-control" id="retention_count" name="retention_count" 
                                               value="{{ task.retention_count }}" min="1" max="100">
                                        <div class="form-text">保留最近的N个备份文件，超出的会被自动删除</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('backup_tasks') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> 保存更改
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 目录浏览器模态框 -->
<div class="modal fade" id="directoryBrowserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">选择目录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="directoryTree">
                    <div class="text-center py-3">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="selectDirectory()">选择</button>
            </div>
        </div>
    </div>
</div>

<!-- Cron帮助模态框 -->
<div class="modal fade" id="cronHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cron表达式帮助</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Cron表达式格式：<code>分 时 日 月 周</code></p>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>字段</th>
                                <th>允许值</th>
                                <th>特殊字符</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>分</td><td>0-59</td><td>, - * /</td></tr>
                            <tr><td>时</td><td>0-23</td><td>, - * /</td></tr>
                            <tr><td>日</td><td>1-31</td><td>, - * ? / L W</td></tr>
                            <tr><td>月</td><td>1-12</td><td>, - * /</td></tr>
                            <tr><td>周</td><td>0-7</td><td>, - * ? / L #</td></tr>
                        </tbody>
                    </table>
                </div>
                <h6>常用示例：</h6>
                <ul class="list-unstyled">
                    <li><code>0 2 * * *</code> - 每天凌晨2点</li>
                    <li><code>0 */6 * * *</code> - 每6小时</li>
                    <li><code>0 0 * * 0</code> - 每周日午夜</li>
                    <li><code>0 0 1 * *</code> - 每月1号午夜</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// 表单验证函数
function validateForm() {
    const name = document.getElementById('task_name').value.trim();
    const sourcePath = document.getElementById('source_path').value.trim();
    const remotePath = document.getElementById('remote_path').value.trim();
    const storageConfigId = document.getElementById('storage_config_id').value;

    if (!name) {
        alert('请输入任务名称');
        return false;
    }

    if (!sourcePath) {
        alert('请选择源路径');
        return false;
    }

    if (!remotePath) {
        alert('请输入远程路径');
        return false;
    }

    if (!storageConfigId) {
        alert('请选择存储配置');
        return false;
    }

    return true;
}

// 切换压缩选项显示
function toggleCompression() {
    const enabled = document.getElementById('compression_enabled').checked;
    const options = document.getElementById('compression_options');
    options.style.display = enabled ? 'block' : 'none';
}

// 切换加密选项显示
function toggleEncryption() {
    const enabled = document.getElementById('encryption_enabled').checked;
    const options = document.getElementById('encryption_options');
    options.style.display = enabled ? 'block' : 'none';
}

// 显示目录浏览器
function showDirectoryBrowser() {
    const modal = new bootstrap.Modal(document.getElementById('directoryBrowserModal'));
    modal.show();
    loadDirectoryTree('/');
}

// 显示Cron帮助
function showCronHelper() {
    const modal = new bootstrap.Modal(document.getElementById('cronHelpModal'));
    modal.show();
}

// 加载目录树
function loadDirectoryTree(path) {
    fetch(`/api/browse-directory?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderDirectoryTree(data.directories, data.files);
            } else {
                document.getElementById('directoryTree').innerHTML =
                    `<div class="alert alert-warning">${data.message}</div>`;
            }
        })
        .catch(error => {
            document.getElementById('directoryTree').innerHTML =
                '<div class="alert alert-danger">加载目录失败</div>';
        });
}

// 渲染目录树
function renderDirectoryTree(directories, files) {
    let html = '<div class="directory-tree">';

    // 添加返回上级目录按钮
    html += `
        <div class="directory-item" onclick="goToParentDirectory()">
            <i class="bi bi-arrow-up"></i> 返回上级目录
        </div>
    `;

    // 添加目录
    directories.forEach(dir => {
        html += `
            <div class="directory-item" onclick="selectPath('${dir.path}')">
                <i class="bi bi-folder"></i> ${dir.name}
            </div>
        `;
    });

    html += '</div>';
    document.getElementById('directoryTree').innerHTML = html;
}

// 选择路径
function selectPath(path) {
    document.getElementById('source_path').value = path;
    bootstrap.Modal.getInstance(document.getElementById('directoryBrowserModal')).hide();
}

// 选择目录
function selectDirectory() {
    const selectedPath = document.querySelector('.directory-item.selected')?.dataset.path;
    if (selectedPath) {
        document.getElementById('source_path').value = selectedPath;
    }
    bootstrap.Modal.getInstance(document.getElementById('directoryBrowserModal')).hide();
}

// 初始化调度设置
function initializeScheduleSettings() {
    // 监听定时类型变化
    const scheduleTypes = document.querySelectorAll('input[name="schedule_type"]');
    scheduleTypes.forEach(radio => {
        radio.addEventListener('change', handleScheduleTypeChange);
    });

    // 监听高级设置切换
    const advancedCheckbox = document.getElementById('show_advanced_cron');
    if (advancedCheckbox) {
        advancedCheckbox.addEventListener('change', toggleAdvancedCron);
    }

    // 监听各种设置变化
    document.getElementById('daily_time')?.addEventListener('change', updateCronExpression);
    document.getElementById('weekly_time')?.addEventListener('change', updateCronExpression);
    document.getElementById('monthly_day')?.addEventListener('change', updateCronExpression);
    document.getElementById('monthly_time')?.addEventListener('change', updateCronExpression);

    // 监听周几选择变化
    const weekCheckboxes = document.querySelectorAll('#weekly_settings input[type="checkbox"]');
    weekCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCronExpression);
    });

    // 根据现有的cron表达式初始化界面
    initializeFromExistingCron();

    // 初始化显示
    handleScheduleTypeChange();
}

function initializeFromExistingCron() {
    const cronInput = document.getElementById('cron_expression');
    const cronValue = cronInput?.value?.trim();

    if (!cronValue) {
        // 没有cron表达式，默认选择手动执行
        document.getElementById('schedule_manual').checked = true;
        return;
    }

    // 尝试解析现有的cron表达式并设置对应的界面
    const parts = cronValue.split(' ');
    if (parts.length === 5) {
        const [minute, hour, day, month, dayOfWeek] = parts;

        // 检查是否是每日执行 (day=*, month=*, dayOfWeek=*)
        if (day === '*' && month === '*' && dayOfWeek === '*') {
            document.getElementById('schedule_daily').checked = true;
            document.getElementById('daily_time').value = `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
        }
        // 检查是否是每周执行 (day=*, month=*, dayOfWeek!=*)
        else if (day === '*' && month === '*' && dayOfWeek !== '*') {
            document.getElementById('schedule_weekly').checked = true;
            document.getElementById('weekly_time').value = `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;

            // 设置周几
            const days = dayOfWeek.split(',');
            days.forEach(d => {
                const checkbox = document.getElementById(`week_${d.trim()}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        // 检查是否是每月执行 (day!=*, month=*, dayOfWeek=*)
        else if (day !== '*' && month === '*' && dayOfWeek === '*') {
            document.getElementById('schedule_monthly').checked = true;
            document.getElementById('monthly_time').value = `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
            document.getElementById('monthly_day').value = day;
        }
        else {
            // 复杂的cron表达式，显示高级模式
            document.getElementById('show_advanced_cron').checked = true;
            toggleAdvancedCron();
        }
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化选项显示状态
    toggleCompression();
    toggleEncryption();
    // 初始化调度设置
    initializeScheduleSettings();
});

function handleScheduleTypeChange() {
    const selectedType = document.querySelector('input[name="schedule_type"]:checked')?.value;

    // 隐藏所有设置面板
    document.querySelectorAll('.schedule-settings').forEach(panel => {
        panel.style.display = 'none';
    });

    // 显示对应的设置面板
    if (selectedType && selectedType !== 'manual') {
        const panel = document.getElementById(selectedType + '_settings');
        if (panel) {
            panel.style.display = 'block';
        }
    }

    // 更新Cron表达式和预览
    updateCronExpression();
}

function updateCronExpression() {
    const selectedType = document.querySelector('input[name="schedule_type"]:checked')?.value;
    let cronExpression = '';
    let previewText = '';

    switch (selectedType) {
        case 'manual':
            cronExpression = '';
            previewText = '当前设置为手动执行，不会自动运行备份任务';
            break;

        case 'daily':
            const dailyTime = document.getElementById('daily_time')?.value || '02:00';
            const [dailyHour, dailyMinute] = dailyTime.split(':');
            cronExpression = `${dailyMinute} ${dailyHour} * * *`;
            previewText = `每天 ${dailyTime} 自动执行备份任务`;
            break;

        case 'weekly':
            const weeklyTime = document.getElementById('weekly_time')?.value || '02:00';
            const [weeklyHour, weeklyMinute] = weeklyTime.split(':');
            const selectedDays = [];
            const weekCheckboxes = document.querySelectorAll('#weekly_settings input[type="checkbox"]:checked');
            weekCheckboxes.forEach(checkbox => {
                selectedDays.push(checkbox.value);
            });

            if (selectedDays.length > 0) {
                cronExpression = `${weeklyMinute} ${weeklyHour} * * ${selectedDays.join(',')}`;
                const dayNames = selectedDays.map(day => {
                    const names = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                    return names[parseInt(day)];
                });
                previewText = `每周 ${dayNames.join('、')} ${weeklyTime} 自动执行备份任务`;
            } else {
                cronExpression = '';
                previewText = '请选择至少一个执行日期';
            }
            break;

        case 'monthly':
            const monthlyTime = document.getElementById('monthly_time')?.value || '02:00';
            const [monthlyHour, monthlyMinute] = monthlyTime.split(':');
            const monthlyDay = document.getElementById('monthly_day')?.value || '1';

            if (monthlyDay === '-1') {
                // 月末的特殊处理，这里简化为28日
                cronExpression = `${monthlyMinute} ${monthlyHour} 28 * *`;
                previewText = `每月月末 ${monthlyTime} 自动执行备份任务`;
            } else {
                cronExpression = `${monthlyMinute} ${monthlyHour} ${monthlyDay} * *`;
                previewText = `每月 ${monthlyDay} 日 ${monthlyTime} 自动执行备份任务`;
            }
            break;
    }

    // 更新Cron表达式输入框
    const cronInput = document.getElementById('cron_expression');
    if (cronInput && !document.getElementById('show_advanced_cron')?.checked) {
        cronInput.value = cronExpression;
    }

    // 更新预览文本
    const previewElement = document.getElementById('schedule_preview_text');
    if (previewElement) {
        previewElement.textContent = previewText;

        // 更新预览样式
        const previewAlert = document.querySelector('#schedule_preview .alert');
        if (previewAlert) {
            if (selectedType === 'manual' || (selectedType === 'weekly' && selectedDays.length === 0)) {
                previewAlert.className = 'alert alert-info d-flex align-items-center';
            } else {
                previewAlert.className = 'alert alert-success d-flex align-items-center';
            }
        }
    }
}

function toggleAdvancedCron() {
    const checkbox = document.getElementById('show_advanced_cron');
    const advancedPanel = document.getElementById('advanced_cron_settings');
    const cronInput = document.getElementById('cron_expression');

    if (checkbox.checked) {
        advancedPanel.style.display = 'block';
        if (cronInput) {
            cronInput.removeAttribute('readonly');
            cronInput.addEventListener('input', handleManualCronChange);
        }
    } else {
        advancedPanel.style.display = 'none';
        if (cronInput) {
            cronInput.setAttribute('readonly', 'readonly');
            cronInput.removeEventListener('input', handleManualCronChange);
        }
        // 重新生成Cron表达式
        updateCronExpression();
    }
}

function handleManualCronChange() {
    const cronInput = document.getElementById('cron_expression');
    const previewElement = document.getElementById('schedule_preview_text');

    if (cronInput && previewElement) {
        const cronValue = cronInput.value.trim();
        if (cronValue) {
            previewElement.textContent = `自定义Cron表达式: ${cronValue}`;
            const previewAlert = document.querySelector('#schedule_preview .alert');
            if (previewAlert) {
                previewAlert.className = 'alert alert-warning d-flex align-items-center';
            }
        } else {
            previewElement.textContent = '当前设置为手动执行，不会自动运行备份任务';
            const previewAlert = document.querySelector('#schedule_preview .alert');
            if (previewAlert) {
                previewAlert.className = 'alert alert-info d-flex align-items-center';
            }
        }
    }
}
</script>

<style>
.directory-tree {
    max-height: 400px;
    overflow-y: auto;
}

.directory-item {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
}

.directory-item:hover {
    background-color: #f8f9fa;
}

.directory-item.selected {
    background-color: #e3f2fd;
    color: #1976d2;
}

.directory-item i {
    margin-right: 0.5rem;
    width: 16px;
}
</style>
{% endblock %}
