{% extends "base.html" %}

{% block title %}备份任务 - RClone备份系统{% endblock %}

{% block extra_css %}
<style>
/* 备份任务卡片样式 */
.backup-task-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.backup-task-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

/* 信息行统一样式 */
.info-row {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
    min-height: 2rem;
}

.info-row:last-child {
    margin-bottom: 0;
}

/* 路径信息区域内的信息行间距 */
.path-info-section .info-row {
    margin-bottom: 0.75rem;
}

.path-info-section .info-row:last-child {
    margin-bottom: 0;
}

.info-label {
    display: inline-flex;
    align-items: center;
    font-weight: 600;
    color: #374151;
    min-width: 90px;
    margin-right: 0.75rem;
    font-size: 0.875rem;
}

.info-label i {
    font-size: 1rem;
    color: #6b7280;
}

/* 统一的代码样式 */
.code-inline {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    font-weight: 500;
    color: #1f2937;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 250px;
    display: inline-block;
    transition: all 0.2s ease;
}

.code-inline:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* 时间显示样式 */
.time-display {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
}

/* 存储名称样式 */
.storage-name {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #065f46;
    white-space: nowrap;
}

/* 执行方式样式 */
.execution-mode {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #92400e;
    white-space: nowrap;
}

/* 执行信息区域 - 移除背景框 */
.execution-info-section {
    padding: 0;
}

/* 统计信息区域 */
.stats-section {
    background: rgba(248, 250, 252, 0.5);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.stat-item {
    text-align: center;
}

.stat-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.125rem;
    font-weight: 700;
    line-height: 1.2;
}

/* 时间显示样式 */
.time-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.1rem;
}

.time-main {
    font-size: 0.9rem;
    font-weight: 700;
    color: #374151;
    line-height: 1;
}

.time-sub {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
    line-height: 1;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .info-label {
        min-width: 80px;
        font-size: 0.8rem;
    }

    .code-inline {
        max-width: 180px;
        font-size: 0.8rem;
    }

    .time-display {
        font-size: 0.8rem;
    }

    .storage-name {
        font-size: 0.8rem;
    }

    .execution-mode {
        font-size: 0.8rem;
    }
}

/* 卡片动画效果 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.backup-task-card {
    animation: fadeInUp 0.6s ease-out;
}

/* 悬停效果增强 */
.info-row:hover .code-inline,
.info-row:hover .time-display,
.info-row:hover .storage-name,
.info-row:hover .execution-mode {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center fade-in-up">
    <div>
        <h1 class="page-title">
            <i class="bi bi-archive"></i>备份任务
        </h1>
        <p class="text-muted mb-0">管理和监控备份任务</p>
    </div>
    <div>
        <button type="button" class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addTaskModal">
            <i class="bi bi-plus-circle me-2"></i>创建备份任务
        </button>
    </div>
</div>

<!-- 备份任务列表 -->
<div class="row g-4 fade-in-up" style="animation-delay: 0.2s;">
    {% if tasks %}
        {% for task in tasks %}
        <div class="col-md-6 col-xl-4">
            <div class="backup-task-card h-100">
                <!-- 卡片头部 -->
                <div class="task-card-header">
                    <div class="d-flex align-items-center mb-3">
                        <div class="task-icon-wrapper me-3">
                            <i class="bi bi-archive"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="task-name mb-1">{{ task.name }}</h5>
                            {% if task.description %}
                                <p class="task-description mb-0">{{ task.description }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 状态徽章 -->
                    <div class="d-flex gap-2 mb-3">
                        <span class="status-badge status-{{ 'active' if task.is_active else 'inactive' }}">
                            <i class="bi bi-{{ 'check-circle' if task.is_active else 'pause-circle' }} me-1"></i>
                            {{ '活跃' if task.is_active else '禁用' }}
                        </span>
                        {% if task.latest_log %}
                            {% if task.latest_log.status == 'success' %}
                                <span class="status-badge status-success">
                                    <i class="bi bi-check-circle me-1"></i>成功
                                </span>
                            {% elif task.latest_log.status == 'failed' %}
                                <span class="status-badge status-error">
                                    <i class="bi bi-x-circle me-1"></i>失败
                                </span>
                            {% elif task.latest_log.status == 'running' %}
                                <span class="status-badge status-running pulse">
                                    <i class="bi bi-clock me-1"></i>运行中
                                </span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                <!-- 卡片主体内容 -->
                <div class="task-card-body">
                    <!-- 路径信息 -->
                    <div class="path-info-section mb-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-row">
                                    <span class="info-label">
                                        <i class="bi bi-cloud me-1"></i>存储配置
                                    </span>
                                    <span class="storage-name">{{ task.storage_config.name if task.storage_config else '未知' }}</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-row">
                                    <span class="info-label">
                                        <i class="bi bi-folder me-1"></i>源路径
                                    </span>
                                    <span class="code-inline" title="{{ task.source_path }}">{{ task.source_path }}</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-row">
                                    <span class="info-label">
                                        <i class="bi bi-arrow-up-right me-1"></i>远程路径
                                    </span>
                                    <span class="code-inline" title="{{ task.remote_path }}">{{ task.remote_path }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 执行信息 -->
                    {% if task.cron_expression %}
                        <div class="info-row mb-3">
                            <span class="info-label">
                                <i class="bi bi-clock me-1"></i>定时表达式
                            </span>
                            <span class="code-inline">{{ task.cron_expression }}</span>
                        </div>
                        <div class="info-row mb-4">
                            <span class="info-label">
                                <i class="bi bi-calendar-event me-1"></i>下次运行
                            </span>
                            {% if task.next_run_at_local %}
                                <span class="time-display">{{ task.next_run_at_local.strftime('%m-%d %H:%M') }}</span>
                            {% elif task.next_run_at %}
                                <span class="time-display">{{ task.next_run_at.strftime('%m-%d %H:%M') }}</span>
                            {% else %}
                                <span class="text-muted">计算中...</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="info-row mb-4">
                            <span class="info-label">
                                <i class="bi bi-hand-index me-1"></i>执行方式
                            </span>
                            <span class="execution-mode">手动执行</span>
                        </div>
                    {% endif %}

                    <!-- 统计信息 -->
                    <div class="stats-section">
                        <div class="row g-3">
                            <div class="col-4">
                                <div class="stat-item">
                                    <div class="stat-label">成功率</div>
                                    <div class="stat-value text-success">{{ task.success_rate }}%</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-item">
                                    <div class="stat-label">备份份数</div>
                                    {% set backup_count = task.backup_logs | selectattr('status', 'equalto', 'success') | list | length %}
                                    <div class="stat-value text-info">{{ backup_count }}/{{ task.retention_count }}</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-item">
                                    <div class="stat-label">最后运行</div>
                                    <div class="stat-value">
                                        {% if task.last_run_at %}
                                            <div class="time-display">
                                                <div class="time-main">{{ task.last_run_at_local.strftime('%m-%d') if task.last_run_at_local else task.last_run_at.strftime('%m-%d') }}</div>
                                                <div class="time-sub">{{ task.last_run_at_local.strftime('%H:%M') if task.last_run_at_local else task.last_run_at.strftime('%H:%M') }}</div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">从未运行</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 卡片操作区域 -->
                <div class="task-card-footer">
                    <div class="action-buttons">
                        <button type="button"
                                class="btn btn-action btn-primary"
                                onclick="runTask({{ task.id }})"
                                title="立即运行备份任务">
                            <i class="bi bi-play-fill me-1"></i>运行
                        </button>
                        <a href="{{ url_for('backup_logs', task_id=task.id) }}"
                           class="btn btn-action btn-outline-info"
                           title="查看备份日志">
                            <i class="bi bi-clock-history me-1"></i>日志
                        </a>
                        <a href="{{ url_for('edit_backup_task', task_id=task.id) }}"
                           class="btn btn-action btn-outline-secondary"
                           title="编辑任务配置">
                            <i class="bi bi-pencil me-1"></i>编辑
                        </a>
                        <button type="button"
                                class="btn btn-action btn-outline-danger"
                                onclick="deleteTask({{ task.id }}, '{{ task.name }}')"
                                title="删除备份任务">
                            <i class="bi bi-trash me-1"></i>删除
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body text-center py-5">
                <i class="bi bi-archive" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">暂无备份任务</h4>
                <p class="text-muted">请创建第一个备份任务开始使用</p>
                {% if storage_configs %}
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <i class="bi bi-plus-circle"></i> 创建第一个备份任务
                </button>
                {% else %}
                <p class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    请先<a href="{{ url_for('storage_configs') }}">配置存储</a>，然后创建备份任务
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- 创建备份任务模态框 -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> 创建备份任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_backup_task') }}" onsubmit="return validateForm()">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task_name" class="form-label">任务名称 *</label>
                                <input type="text" class="form-control" id="task_name" name="name" required
                                       placeholder="例如：每日文档备份">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="storage_config_id" class="form-label">存储配置 *</label>
                                <select class="form-select" id="storage_config_id" name="storage_config_id" required>
                                    <option value="">请选择存储配置</option>
                                    {% for config in storage_configs %}
                                    <option value="{{ config.id }}">{{ config.name }} ({{ config.storage_type }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="description" class="form-label">任务描述</label>
                                <textarea class="form-control" id="description" name="description" rows="2"
                                          placeholder="可选，描述此备份任务的用途"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">任务状态</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="is_active_create" name="is_active" checked>
                                    <label class="form-check-label" for="is_active_create">
                                        <i class="bi bi-power me-1"></i>启用任务
                                    </label>
                                </div>
                                <div class="form-text">创建后立即启用任务</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="source_path" class="form-label">源路径 *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="source_path" name="source_path" required
                                           placeholder="/home/user/documents">
                                    <button class="btn btn-outline-secondary" type="button" onclick="showDirectoryBrowser()">
                                        <i class="bi bi-folder"></i> 浏览
                                    </button>
                                </div>
                                <div class="form-text">要备份的文件或目录的完整路径</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="remote_path" class="form-label">远程路径 *</label>
                                <input type="text" class="form-control" id="remote_path" name="remote_path" required
                                       placeholder="backups/documents">
                                <div class="form-text">在云存储中的保存路径</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">定时设置</label>

                        <!-- 定时类型选择 -->
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6 col-md-3">
                                    <input type="radio" class="btn-check" name="schedule_type" id="schedule_manual" value="manual" checked>
                                    <label class="btn btn-outline-primary w-100" for="schedule_manual">
                                        <i class="bi bi-hand-index me-1"></i>手动执行
                                    </label>
                                </div>
                                <div class="col-6 col-md-3">
                                    <input type="radio" class="btn-check" name="schedule_type" id="schedule_daily" value="daily">
                                    <label class="btn btn-outline-primary w-100" for="schedule_daily">
                                        <i class="bi bi-calendar-day me-1"></i>每日
                                    </label>
                                </div>
                                <div class="col-6 col-md-3">
                                    <input type="radio" class="btn-check" name="schedule_type" id="schedule_weekly" value="weekly">
                                    <label class="btn btn-outline-primary w-100" for="schedule_weekly">
                                        <i class="bi bi-calendar-week me-1"></i>每周
                                    </label>
                                </div>
                                <div class="col-6 col-md-3">
                                    <input type="radio" class="btn-check" name="schedule_type" id="schedule_monthly" value="monthly">
                                    <label class="btn btn-outline-primary w-100" for="schedule_monthly">
                                        <i class="bi bi-calendar-month me-1"></i>每月
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 每日设置 -->
                        <div id="daily_settings" class="schedule-settings" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="daily_time" class="form-label">执行时间</label>
                                    <input type="time" class="form-control" id="daily_time" value="02:00">
                                    <div class="form-text">每天在此时间执行备份</div>
                                </div>
                            </div>
                        </div>

                        <!-- 每周设置 -->
                        <div id="weekly_settings" class="schedule-settings" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">执行日期</label>
                                    <div class="d-flex flex-wrap gap-2 mb-2">
                                        <input type="checkbox" class="btn-check" id="week_1" value="1">
                                        <label class="btn btn-outline-secondary btn-sm" for="week_1">周一</label>

                                        <input type="checkbox" class="btn-check" id="week_2" value="2">
                                        <label class="btn btn-outline-secondary btn-sm" for="week_2">周二</label>

                                        <input type="checkbox" class="btn-check" id="week_3" value="3">
                                        <label class="btn btn-outline-secondary btn-sm" for="week_3">周三</label>

                                        <input type="checkbox" class="btn-check" id="week_4" value="4">
                                        <label class="btn btn-outline-secondary btn-sm" for="week_4">周四</label>

                                        <input type="checkbox" class="btn-check" id="week_5" value="5">
                                        <label class="btn btn-outline-secondary btn-sm" for="week_5">周五</label>

                                        <input type="checkbox" class="btn-check" id="week_6" value="6">
                                        <label class="btn btn-outline-secondary btn-sm" for="week_6">周六</label>

                                        <input type="checkbox" class="btn-check" id="week_0" value="0">
                                        <label class="btn btn-outline-secondary btn-sm" for="week_0">周日</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="weekly_time" class="form-label">执行时间</label>
                                    <input type="time" class="form-control" id="weekly_time" value="02:00">
                                    <div class="form-text">在选定的日期执行备份</div>
                                </div>
                            </div>
                        </div>

                        <!-- 每月设置 -->
                        <div id="monthly_settings" class="schedule-settings" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="monthly_day" class="form-label">执行日期</label>
                                    <select class="form-select" id="monthly_day">
                                        <option value="1" selected>1日</option>
                                        <option value="2">2日</option>
                                        <option value="3">3日</option>
                                        <option value="4">4日</option>
                                        <option value="5">5日</option>
                                        <option value="10">10日</option>
                                        <option value="15">15日</option>
                                        <option value="20">20日</option>
                                        <option value="25">25日</option>
                                        <option value="28">28日</option>
                                        <option value="-1">月末</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="monthly_time" class="form-label">执行时间</label>
                                    <input type="time" class="form-control" id="monthly_time" value="02:00">
                                </div>
                                <div class="col-md-4">
                                    <div class="form-text mt-4">每月在指定日期和时间执行备份</div>
                                </div>
                            </div>
                        </div>

                        <!-- 高级设置 -->
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_advanced_cron">
                                <label class="form-check-label fw-medium" for="show_advanced_cron">
                                    <i class="bi bi-gear me-1"></i>高级设置 (Cron表达式)
                                </label>
                            </div>
                        </div>

                        <!-- Cron表达式输入 (高级模式) -->
                        <div id="advanced_cron_settings" style="display: none;" class="mt-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="cron_expression" name="cron_expression"
                                       placeholder="0 2 * * *" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="showCronHelp()">
                                    <i class="bi bi-question-circle"></i>
                                </button>
                            </div>
                            <div class="form-text">当前生成的Cron表达式，可手动修改</div>
                        </div>

                        <!-- 预览信息 -->
                        <div id="schedule_preview" class="mt-3">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="bi bi-info-circle me-2 flex-shrink-0"></i>
                                <span id="schedule_preview_text" class="mb-0">当前设置为手动执行，不会自动运行备份任务</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 备份选项设置 -->
                    <div class="mb-4">
                        <h6 class="fw-medium mb-3">
                            <i class="bi bi-gear me-2"></i>备份选项
                        </h6>

                        <!-- 复选框选项 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="compression_enabled"
                                           name="compression_enabled" checked onchange="toggleCompression()">
                                    <label class="form-check-label" for="compression_enabled">
                                        <i class="bi bi-file-zip me-1"></i>启用压缩
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="encryption_enabled"
                                           name="encryption_enabled" onchange="toggleEncryption()">
                                    <label class="form-check-label" for="encryption_enabled">
                                        <i class="bi bi-shield-lock me-1"></i>启用加密
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 保留策略 -->
                        <div class="row">
                            <div class="col-md-6">
                                <label for="retention_count" class="form-label">保留份数</label>
                                <div class="input-group" style="max-width: 200px;">
                                    <input type="number" class="form-control" id="retention_count"
                                           name="retention_count" value="10" min="1" max="100">
                                    <span class="input-group-text">份</span>
                                </div>
                                <div class="form-text">保留最新的备份文件数量</div>
                            </div>
                        </div>
                    </div>

                    <!-- 压缩设置 -->
                    <div id="compression_type_field" class="mb-4">
                        <h6 class="fw-medium mb-3">
                            <i class="bi bi-file-zip me-2"></i>压缩设置
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="compression_type" class="form-label">压缩格式</label>
                                <select class="form-select" id="compression_type" name="compression_type">
                                    <option value="tar.gz" selected>tar.gz (推荐)</option>
                                    <option value="zip">zip</option>
                                </select>
                                <div class="form-text">选择压缩文件的格式</div>
                            </div>
                        </div>
                    </div>

                    <!-- 加密设置 -->
                    <div id="encryption_password_field" class="mb-4" style="display: none;">
                        <h6 class="fw-medium mb-3">
                            <i class="bi bi-shield-lock me-2"></i>加密设置
                        </h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="encryption_password" class="form-label">加密密码 *</label>
                                <input type="password" class="form-control" id="encryption_password"
                                       name="encryption_password" placeholder="请输入加密密码">
                                <div class="form-text text-warning mt-2">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    请妥善保管加密密码，丢失后无法恢复数据
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 创建任务
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cron帮助模态框 -->
<div class="modal fade" id="cronHelpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock"></i> Cron表达式帮助
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Cron表达式格式：<code>分 时 日 月 周</code></p>
                
                <h6>常用示例：</h6>
                <table class="table table-sm">
                    <tr><td><code>0 2 * * *</code></td><td>每天凌晨2点</td></tr>
                    <tr><td><code>0 */6 * * *</code></td><td>每6小时</td></tr>
                    <tr><td><code>0 3 * * 0</code></td><td>每周日凌晨3点</td></tr>
                    <tr><td><code>0 1 1 * *</code></td><td>每月1号凌晨1点</td></tr>
                    <tr><td><code>*/30 * * * *</code></td><td>每30分钟</td></tr>
                </table>
                
                <h6>字段说明：</h6>
                <ul>
                    <li><strong>分</strong>：0-59</li>
                    <li><strong>时</strong>：0-23</li>
                    <li><strong>日</strong>：1-31</li>
                    <li><strong>月</strong>：1-12</li>
                    <li><strong>周</strong>：0-7 (0和7都表示周日)</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 目录浏览器模态框 -->
<div class="modal fade" id="directoryBrowserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder"></i> 选择目录
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 当前路径显示 -->
                <div class="mb-3">
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="navigateToParent()" id="parentBtn">
                            <i class="bi bi-arrow-up"></i> 上级
                        </button>
                        <div class="flex-grow-1">
                            <input type="text" class="form-control form-control-sm" id="currentPath" readonly>
                        </div>
                    </div>
                </div>

                <!-- 目录树容器 -->
                <div class="directory-browser" id="directoryContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div class="mt-2">正在加载目录...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="selectCurrentPath()">选择当前目录</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleEncryption() {
    const checkbox = document.getElementById('encryption_enabled');
    const passwordField = document.getElementById('encryption_password_field');
    const passwordInput = document.getElementById('encryption_password');

    if (checkbox.checked) {
        passwordField.style.display = 'block';
        passwordInput.required = true;
    } else {
        passwordField.style.display = 'none';
        passwordInput.required = false;
        passwordInput.value = '';
    }
}

function toggleCompression() {
    const checkbox = document.getElementById('compression_enabled');
    const typeField = document.getElementById('compression_type_field');

    if (checkbox.checked) {
        typeField.style.display = 'block';
    } else {
        typeField.style.display = 'none';
    }
}

function showCronHelp() {
    new bootstrap.Modal(document.getElementById('cronHelpModal')).show();
}

function runTask(taskId) {
    if (confirm('确定要立即运行此备份任务吗？\n\n备份过程可能需要一些时间，请耐心等待。')) {
        // 显示加载状态
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>运行中...';
        button.disabled = true;

        // 创建表单并提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/backup-tasks/${taskId}/run`;
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteTask(taskId, taskName) {
    if (confirm(`确定要删除备份任务"${taskName}"吗？\n\n这将同时删除所有相关的备份日志，此操作不可恢复。`)) {
        // 创建表单并提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/backup-tasks/${taskId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

// 表单验证函数
function validateForm() {
    const name = document.getElementById('task_name').value.trim();
    const sourcePath = document.getElementById('source_path').value.trim();
    const remotePath = document.getElementById('remote_path').value.trim();
    const storageConfigId = document.getElementById('storage_config_id').value;

    if (!name) {
        alert('请输入任务名称');
        return false;
    }

    if (!sourcePath) {
        alert('请选择源路径');
        return false;
    }

    if (!remotePath) {
        alert('请输入远程路径');
        return false;
    }

    if (!storageConfigId) {
        alert('请选择存储配置');
        return false;
    }

    // 验证加密设置
    const encryptionEnabled = document.getElementById('encryption_enabled').checked;
    const encryptionPassword = document.getElementById('encryption_password').value.trim();

    if (encryptionEnabled && !encryptionPassword) {
        alert('启用加密时必须设置加密密码');
        return false;
    }

    // 验证定时设置
    const scheduleType = document.querySelector('input[name="schedule_type"]:checked')?.value;
    if (scheduleType === 'weekly') {
        const selectedDays = document.querySelectorAll('#weekly_settings input[type="checkbox"]:checked');
        if (selectedDays.length === 0) {
            alert('每周备份模式下请至少选择一个执行日期');
            return false;
        }
    }

    return true;
}

// 目录浏览器相关功能
let currentBrowsePath = '/';

function showDirectoryBrowser() {
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('directoryBrowserModal'));
    modal.show();

    // 加载根目录
    loadDirectory('/');
}

function loadDirectory(path) {
    currentBrowsePath = path;
    document.getElementById('currentPath').value = path;

    // 显示加载状态
    document.getElementById('directoryContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <div class="mt-2">正在加载目录...</div>
        </div>
    `;

    // 更新上级按钮状态
    const parentBtn = document.getElementById('parentBtn');
    parentBtn.disabled = (path === '/');

    // 发送请求获取目录内容
    fetch(`/api/browse-directory?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            renderDirectoryContent(data);
        })
        .catch(error => {
            document.getElementById('directoryContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    加载失败: ${error.message}
                </div>
            `;
        });
}

function renderDirectoryContent(data) {
    const container = document.getElementById('directoryContent');
    let html = '';

    if (data.directories.length === 0 && data.files.length === 0) {
        html = '<div class="text-center text-muted py-4">此目录为空</div>';
    } else {
        html = '<div class="list-group list-group-flush">';

        // 渲染目录
        data.directories.forEach(dir => {
            html += `
                <div class="list-group-item list-group-item-action d-flex align-items-center"
                     onclick="loadDirectory('${dir.path.replace(/'/g, "\\'")}')">
                    <i class="bi bi-folder-fill text-primary me-3"></i>
                    <div class="flex-grow-1">
                        <div class="fw-medium">${escapeHtml(dir.name)}</div>
                        <small class="text-muted">目录</small>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </div>
            `;
        });

        // 渲染文件（仅显示，不可选择）
        data.files.forEach(file => {
            const fileSize = formatFileSize(file.size);
            html += `
                <div class="list-group-item d-flex align-items-center text-muted">
                    <i class="bi bi-file-earmark me-3"></i>
                    <div class="flex-grow-1">
                        <div>${escapeHtml(file.name)}</div>
                        <small>${fileSize}</small>
                    </div>
                </div>
            `;
        });

        html += '</div>';
    }

    container.innerHTML = html;
}

function navigateToParent() {
    if (currentBrowsePath !== '/') {
        const parentPath = currentBrowsePath.substring(0, currentBrowsePath.lastIndexOf('/')) || '/';
        loadDirectory(parentPath);
    }
}

function selectCurrentPath() {
    // 将选择的路径设置到源路径输入框
    document.getElementById('source_path').value = currentBrowsePath;

    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('directoryBrowserModal'));
    modal.hide();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 定时设置相关功能
document.addEventListener('DOMContentLoaded', function() {
    initializeScheduleSettings();
});

function initializeScheduleSettings() {
    // 监听定时类型变化
    const scheduleTypes = document.querySelectorAll('input[name="schedule_type"]');
    scheduleTypes.forEach(radio => {
        radio.addEventListener('change', handleScheduleTypeChange);
    });

    // 监听高级设置切换
    const advancedCheckbox = document.getElementById('show_advanced_cron');
    if (advancedCheckbox) {
        advancedCheckbox.addEventListener('change', toggleAdvancedCron);
    }

    // 监听各种设置变化
    document.getElementById('daily_time')?.addEventListener('change', updateCronExpression);
    document.getElementById('weekly_time')?.addEventListener('change', updateCronExpression);
    document.getElementById('monthly_day')?.addEventListener('change', updateCronExpression);
    document.getElementById('monthly_time')?.addEventListener('change', updateCronExpression);

    // 监听周几选择变化
    const weekCheckboxes = document.querySelectorAll('#weekly_settings input[type="checkbox"]');
    weekCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCronExpression);
    });

    // 初始化显示
    handleScheduleTypeChange();
}

function handleScheduleTypeChange() {
    const selectedType = document.querySelector('input[name="schedule_type"]:checked')?.value;

    // 隐藏所有设置面板
    document.querySelectorAll('.schedule-settings').forEach(panel => {
        panel.style.display = 'none';
    });

    // 显示对应的设置面板
    if (selectedType && selectedType !== 'manual') {
        const panel = document.getElementById(selectedType + '_settings');
        if (panel) {
            panel.style.display = 'block';
        }
    }

    // 更新Cron表达式和预览
    updateCronExpression();
}

function updateCronExpression() {
    const selectedType = document.querySelector('input[name="schedule_type"]:checked')?.value;
    let cronExpression = '';
    let previewText = '';

    switch (selectedType) {
        case 'manual':
            cronExpression = '';
            previewText = '当前设置为手动执行，不会自动运行备份任务';
            break;

        case 'daily':
            const dailyTime = document.getElementById('daily_time')?.value || '02:00';
            const [dailyHour, dailyMinute] = dailyTime.split(':');
            cronExpression = `${dailyMinute} ${dailyHour} * * *`;
            previewText = `每天 ${dailyTime} 自动执行备份任务`;
            break;

        case 'weekly':
            const weeklyTime = document.getElementById('weekly_time')?.value || '02:00';
            const [weeklyHour, weeklyMinute] = weeklyTime.split(':');
            const selectedDays = [];
            const weekCheckboxes = document.querySelectorAll('#weekly_settings input[type="checkbox"]:checked');
            weekCheckboxes.forEach(checkbox => {
                selectedDays.push(checkbox.value);
            });

            if (selectedDays.length > 0) {
                cronExpression = `${weeklyMinute} ${weeklyHour} * * ${selectedDays.join(',')}`;
                const dayNames = selectedDays.map(day => {
                    const names = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                    return names[parseInt(day)];
                });
                previewText = `每周 ${dayNames.join('、')} ${weeklyTime} 自动执行备份任务`;
            } else {
                cronExpression = '';
                previewText = '请选择至少一个执行日期';
            }
            break;

        case 'monthly':
            const monthlyTime = document.getElementById('monthly_time')?.value || '02:00';
            const [monthlyHour, monthlyMinute] = monthlyTime.split(':');
            const monthlyDay = document.getElementById('monthly_day')?.value || '1';

            if (monthlyDay === '-1') {
                // 月末的特殊处理，这里简化为28日
                cronExpression = `${monthlyMinute} ${monthlyHour} 28 * *`;
                previewText = `每月月末 ${monthlyTime} 自动执行备份任务`;
            } else {
                cronExpression = `${monthlyMinute} ${monthlyHour} ${monthlyDay} * *`;
                previewText = `每月 ${monthlyDay} 日 ${monthlyTime} 自动执行备份任务`;
            }
            break;
    }

    // 更新Cron表达式输入框
    const cronInput = document.getElementById('cron_expression');
    if (cronInput) {
        cronInput.value = cronExpression;
    }

    // 更新预览文本
    const previewElement = document.getElementById('schedule_preview_text');
    if (previewElement) {
        previewElement.textContent = previewText;
    }

    // 更新预览样式
    const previewAlert = document.querySelector('#schedule_preview .alert');
    if (previewAlert) {
        previewAlert.className = 'alert ' + (cronExpression ? 'alert-success' : 'alert-info');
    }
}

function toggleAdvancedCron() {
    const checkbox = document.getElementById('show_advanced_cron');
    const advancedPanel = document.getElementById('advanced_cron_settings');
    const cronInput = document.getElementById('cron_expression');

    if (checkbox.checked) {
        advancedPanel.style.display = 'block';
        if (cronInput) {
            cronInput.removeAttribute('readonly');
            cronInput.addEventListener('input', handleManualCronChange);
        }
    } else {
        advancedPanel.style.display = 'none';
        if (cronInput) {
            cronInput.setAttribute('readonly', 'readonly');
            cronInput.removeEventListener('input', handleManualCronChange);
        }
        // 重新生成Cron表达式
        updateCronExpression();
    }
}

function handleManualCronChange() {
    const cronInput = document.getElementById('cron_expression');
    const previewElement = document.getElementById('schedule_preview_text');

    if (cronInput && previewElement) {
        const cronValue = cronInput.value.trim();
        if (cronValue) {
            previewElement.textContent = `自定义Cron表达式: ${cronValue}`;
            const previewAlert = document.querySelector('#schedule_preview .alert');
            if (previewAlert) {
                previewAlert.className = 'alert alert-warning';
            }
        } else {
            previewElement.textContent = '当前设置为手动执行，不会自动运行备份任务';
            const previewAlert = document.querySelector('#schedule_preview .alert');
            if (previewAlert) {
                previewAlert.className = 'alert alert-info';
            }
        }
    }
}
</script>
{% endblock %}
