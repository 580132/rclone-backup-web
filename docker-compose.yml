version: '3.8'

services:
  backup-web:
    build: .
    container_name: rclone-backup-web
    ports:
      - "5000:5000"
    volumes:
      # 数据持久化
      - ./data:/app/data
      - ./logs:/app/logs
      # Docker socket用于调用rclone容器
      - /var/run/docker.sock:/var/run/docker.sock
      # rclone配置文件
      - ./data/rclone_configs:/app/data/rclone_configs
    environment:
      - FLASK_ENV=production
      - DOCKER_ENV=true
      - RCLONE_CONFIG_DIR=/app/data/rclone_configs
      - DATABASE_URL=sqlite:///data/database.db
      - SECRET_KEY=your-secret-key-change-this
    restart: unless-stopped
    networks:
      - backup-network

  # rclone服务容器（用于执行rclone命令）
  rclone:
    image: rclone/rclone:latest
    container_name: rclone-service
    volumes:
      # rclone配置文件
      - ./data/rclone_configs:/config/rclone
      # 临时文件目录
      - ./data/temp:/data/temp
      # 备份源目录（可根据需要调整）
      - ./backup-sources:/backup-sources:ro
    environment:
      - RCLONE_CONFIG=/config/rclone/rclone.conf
    networks:
      - backup-network
    # 保持容器运行
    command: ["sleep", "infinity"]
    restart: unless-stopped

networks:
  backup-network:
    driver: bridge

volumes:
  backup-data:
    driver: local
