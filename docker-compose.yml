version: '3.8'

services:
  backup-web:
    build: .
    container_name: rclone-backup-web
    ports:
      - "5000:5000"
    volumes:
      # 数据持久化
      - ./data:/app/data
      - ./logs:/app/logs
      # Docker socket用于调用rclone容器
      - /var/run/docker.sock:/var/run/docker.sock
      # 备份源目录挂载：将宿主机根目录挂载到容器的/host目录
      - /:/host:ro  # 挂载整个宿主机根目录到/host（只读）
    environment:
      - FLASK_ENV=production
      - DOCKER_ENV=true
      - RCLONE_CONFIG_DIR=/app/data/rclone_configs
      - DATABASE_URL=sqlite:////app/data/database.db
      - SECRET_KEY=your-secret-key-change-this
      # 日志配置 - 可选值: DEBUG, INFO, WARNING, ERROR
      # DEBUG: 最详细的日志，包括所有调试信息、rclone配置内容等
      # INFO: 标准日志级别，包含重要操作信息
      # WARNING: 仅警告和错误信息
      # ERROR: 仅错误信息
#      - LOG_LEVEL=INFO
      # 取消注释下面这行以开启最详细的调试日志
      - LOG_LEVEL=DEBUG
    restart: unless-stopped
    networks:
      - backup-network

  # rclone服务容器（用于执行rclone命令）
  rclone:
    image: rclone/rclone:latest
    container_name: rclone-service
    volumes:
      # rclone配置文件 - 挂载到与主应用相同的路径结构
      - ./data:/app/data
      # 备份源目录（与主应用保持一致的挂载）
      - /:/host:ro  # 挂载整个宿主机根目录到/host（只读）
    environment:
      - RCLONE_CONFIG=/app/data/rclone_configs/rclone.conf
    networks:
      - backup-network
    # 保持容器运行 - 使用rclone rcd命令启动RPC守护进程
    command: ["rcd", "--rc-addr=0.0.0.0:5572", "--rc-no-auth"]
    restart: unless-stopped

networks:
  backup-network:
    driver: bridge

volumes:
  backup-data:
    driver: local
