version: '3.8'

# 安全的Docker Compose配置示例
# 只挂载需要备份的特定目录，而不是整个根目录

services:
  backup-web:
    build: .
    container_name: rclone-backup-web
    ports:
      - "5000:5000"
    volumes:
      # 数据持久化
      - ./data:/app/data
      - ./logs:/app/logs
      # Docker socket用于调用rclone容器
      - /var/run/docker.sock:/var/run/docker.sock
      # rclone配置文件
      - ./data/rclone_configs:/app/data/rclone_configs
      
      # 备份源目录挂载：将宿主机根目录挂载到容器的/host目录
      - /:/host:ro  # 挂载整个宿主机根目录到/host（只读）

      # 可选：如果只想挂载特定目录，可以使用以下配置替代上面的配置
      # - /home:/host/home:ro
      # - /etc:/host/etc:ro
      # - /var/www:/host/var/www:ro
      # - /var/log:/host/var/log:ro
      # - /var/lib:/host/var/lib:ro
      
    environment:
      - FLASK_ENV=production
      - DOCKER_ENV=true
      - RCLONE_CONFIG_DIR=/app/data/rclone_configs
      - DATABASE_URL=sqlite:///data/database.db
      - SECRET_KEY=your-secret-key-change-this
    restart: unless-stopped
    networks:
      - backup-network

  # rclone服务容器（用于执行rclone命令）
  rclone:
    image: rclone/rclone:latest
    container_name: rclone-service
    volumes:
      # rclone配置文件
      - ./data/rclone_configs:/config/rclone
      # 临时文件目录（与主应用共享）
      - ./data/temp:/data/temp
      
      # 备份源目录（必须与backup-web容器保持完全一致）
      - /:/host:ro  # 挂载整个宿主机根目录到/host（只读）
      
    environment:
      - RCLONE_CONFIG=/config/rclone/rclone.conf
    networks:
      - backup-network
    # 保持容器运行
    command: ["sleep", "infinity"]
    restart: unless-stopped

networks:
  backup-network:
    driver: bridge

volumes:
  backup-data:
    driver: local
